function doGet(e) {
  e = e || {};
  var params = e.parameter || {};

  // â˜… ERP ë„ë©´ ëª©ë¡ API: ?action=list ì¼ ë•Œ JSON ë°°ì—´ ë°˜í™˜
  if (params.action == 'list') {
    try {
      var list = getDrawingListForErp_();
      return ContentService.createTextOutput(list)
        .setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      return ContentService.createTextOutput(JSON.stringify({ error: String(err.message || err) }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  if (params.downloadPdf && (params.fileId || params.siteName)) {
    try {
      var pdfBlob = null;
      var fileName = 'ê²¬ì ì„œ.pdf';
      if (params.fileId) {
        var fileId = String(params.fileId || '').trim();
        if (fileId) {
          var file = DriveApp.getFileById(fileId);
          pdfBlob = file.getBlob();
          fileName = file.getName();
        }
      }
      if (!pdfBlob && params.siteName) {
        var gen = generateEstimatePdf_(decodeURIComponent(String(params.siteName || '').trim()));
        if (gen && gen.blob) { pdfBlob = gen.blob; fileName = gen.name || fileName; }
      }
      if (!pdfBlob) {
        if (params.format == 'json') {
          return ContentService.createTextOutput(JSON.stringify({ error: 'no_sheet', message: 'ê²¬ì ì´ ì‹œíŠ¸ì— ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê²¬ì ë‚´ê¸°ì—ì„œ "ì €ì¥" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¨¼ì € ì €ì¥í•œ ë’¤ PDF ì €ì¥ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.' })).setMimeType(ContentService.MimeType.JSON);
        }
        return HtmlService.createHtmlOutput('<p>íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>');
      }
      var b64 = Utilities.base64Encode(pdfBlob.getBytes());
      var chunkSize = 32000;
      var chunks = [];
      for (var i = 0; i < b64.length; i += chunkSize) chunks.push(b64.substring(i, Math.min(i + chunkSize, b64.length)));
      var fn = (fileName || 'ê²¬ì ì„œ.pdf').replace(/"/g, '').replace(/\\/g, '').replace(/</g, '').replace(/>/g, '');
      if (params.format == 'json') {
        return ContentService.createTextOutput(JSON.stringify({ chunks: chunks, name: fn })).setMimeType(ContentService.MimeType.JSON);
      }
      var chunksJson = JSON.stringify(chunks);
      var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>PDF ë‹¤ìš´ë¡œë“œ</title></head><body><p>ë‹¤ìš´ë¡œë“œ ì¤‘...</p><script type="application/json" id="d">' + chunksJson + '</script><script>var c=JSON.parse(document.getElementById("d").textContent);var b=atob(c.join(""));var a=new Uint8Array(b.length);for(var i=0;i<b.length;i++)a[i]=b.charCodeAt(i);var blob=new Blob([a],{type:"application/pdf"});var u=URL.createObjectURL(blob);var l=document.createElement("a");l.href=u;l.download="' + fn + '";l.click();document.body.innerHTML="<p>ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";</script></body></html>';
      return HtmlService.createHtmlOutput(html).setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
    } catch (err) {
      if (params.format == 'json') {
        return ContentService.createTextOutput(JSON.stringify({ error: 'server', message: 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || err) })).setMimeType(ContentService.MimeType.JSON);
      }
      return HtmlService.createHtmlOutput('<p>ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + (err.message || err) + '</p>');
    }
  }
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('ìŠ¤ë§ˆíŠ¸ í˜„ì¥ê´€ë¦¬ V7')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/** HTML include */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function doPost(e) {
  e = e || {};
  var params = e.parameter || {};  // â˜… ERP ë„ë©´ ëª©ë¡ API: ?action=list ì¼ ë•Œ JSON ë°°ì—´ ë°˜í™˜
  if (params.action == 'list') {
    try {
      var list = getDrawingListForErp_();
      return ContentService.createTextOutput(list)
        .setMimeType(ContentService.MimeType.JSON)
        .setHeader('Access-Control-Allow-Origin', '*');
    } catch (err) {
      return ContentService.createTextOutput(JSON.stringify({ error: String(err.message || err) }))
        .setMimeType(ContentService.MimeType.JSON)
        .setHeader('Access-Control-Allow-Origin', '*');
    }
  }
  var isPdfFromData = params.downloadPdfFromData !== undefined && params.downloadPdfFromData !== '';
  var formatHtml = params.format === 'html';
  var formatJson = params.format === 'json';
  if (isPdfFromData && (formatJson || formatHtml)) {
    try {
      var data = null;
      if (params.payload) data = JSON.parse(params.payload);
      else if (e.postData && e.postData.contents) data = JSON.parse(e.postData.contents);
      if (!data || !data.items || !data.items.length) {
        if (formatHtml) return HtmlService.createHtmlOutput('<p>ê²¬ì  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_data', message: 'ê²¬ì  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.' })).setMimeType(ContentService.MimeType.JSON);
      }
      var gen;
      try {
        gen = generateEstimatePdfFromData_(data);
      } catch (genErr) {
        if (formatHtml) return HtmlService.createHtmlOutput('<p>PDF ìƒì„± ì‹¤íŒ¨: ' + String(genErr.message || genErr) + '</p>').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_pdf', message: 'PDF ìƒì„± ì‹¤íŒ¨: ' + String(genErr.message || genErr) })).setMimeType(ContentService.MimeType.JSON);
      }
      if (!gen || !gen.blob) {
        if (formatHtml) return HtmlService.createHtmlOutput('<p>PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_pdf', message: 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })).setMimeType(ContentService.MimeType.JSON);
      }
      var b64 = Utilities.base64Encode(gen.blob.getBytes());
      var chunkSize = 32000;
      var chunks = [];
      for (var i = 0; i < b64.length; i += chunkSize) chunks.push(b64.substring(i, Math.min(i + chunkSize, b64.length)));
      var fn = (gen.name || 'ê²¬ì ì„œ.pdf').replace(/"/g, '').replace(/\\/g, '').replace(/</g, '').replace(/>/g, '');
      if (formatHtml) {
        var chunksJson = JSON.stringify(chunks);
        var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>PDF ë‹¤ìš´ë¡œë“œ</title></head><body><p>ë‹¤ìš´ë¡œë“œ ì¤‘...</p><script type="application/json" id="d">' + chunksJson + '</script><script>var c=JSON.parse(document.getElementById("d").textContent);var b=atob(c.join(""));var a=new Uint8Array(b.length);for(var i=0;i<b.length;i++)a[i]=b.charCodeAt(i);var blob=new Blob([a],{type:"application/pdf"});var u=URL.createObjectURL(blob);var l=document.createElement("a");l.href=u;l.download="' + fn + '";l.click();document.body.innerHTML="<p>ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½ì„ ë‹«ì•„ë„ ë©ë‹ˆë‹¤.</p>";</script></body></html>';
        return HtmlService.createHtmlOutput(html).setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      }
      return ContentService.createTextOutput(JSON.stringify({ chunks: chunks, name: fn })).setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      if (formatHtml) return HtmlService.createHtmlOutput('<p>ì˜¤ë¥˜: ' + String(err.message || err) + '</p>').setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
      return ContentService.createTextOutput(JSON.stringify({ error: 'server', message: String(err.message || err) })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  if (params.sendEstimateEmail !== undefined && params.sendEstimateEmail !== '' && params.format == 'json') {
    try {
      var data = null;
      if (e.postData && e.postData.contents) data = JSON.parse(e.postData.contents);
      if (!data || !data.items || !data.items.length) {
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_data', message: 'ê²¬ì  í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.' })).setMimeType(ContentService.MimeType.JSON);
      }
      var gen;
      try {
        gen = generateEstimatePdfFromData_(data);
      } catch (genErr) {
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_pdf', message: 'PDF ìƒì„± ì‹¤íŒ¨: ' + String(genErr.message || genErr) })).setMimeType(ContentService.MimeType.JSON);
      }
      if (!gen || !gen.blob) {
        return ContentService.createTextOutput(JSON.stringify({ error: 'no_pdf', message: 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' })).setMimeType(ContentService.MimeType.JSON);
      }
      var fn = (gen.name || 'ê²¬ì ì„œ.pdf').replace(/[/\\?*:\[\]"]/g, '_');
      gen.blob.setName(fn);
      var subject = 'ê²¬ì ì„œ - ' + (data.siteName || 'í˜„ì¥');
      var body = 'ê²¬ì ì„œë¥¼ ì²¨ë¶€í•©ë‹ˆë‹¤.\n\ní˜„ì¥: ' + (data.siteName || '') + '\nì´ì•¡: ' + (data.total != null ? String(data.total) + 'ì›' : '');
      GmailApp.sendEmail('limoonsa@gmail.com', subject, body, { attachments: [gen.blob] });
      return ContentService.createTextOutput(JSON.stringify({ ok: true, message: 'limoonsa@gmail.comìœ¼ë¡œ ê²¬ì ì„œë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.' })).setMimeType(ContentService.MimeType.JSON);
    } catch (err) {
      return ContentService.createTextOutput(JSON.stringify({ error: 'server', message: String(err.message || err) })).setMimeType(ContentService.MimeType.JSON);
    }
  }
  return ContentService.createTextOutput(JSON.stringify({ error: 'bad_request' })).setMimeType(ContentService.MimeType.JSON);
}

/** HTML include */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

/** âœ… ì›¹ì•±ì—ì„œ ì‚¬ìš©í•  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID (í˜„ì¥ê´€ë¦¬ ì‹œìŠ¤í…œver.8) - Script Propertiesì— SPREADSHEET_IDê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„  ì‚¬ìš© */
var DEFAULT_SPREADSHEET_ID = '1MVxXzs-SeZqkaa449nQ6WNDeVehFFznza387RdMJsJj74ARsu2opUPIo';

/**
 * âœ… ì›¹ì•±ì—ì„œ ì‚¬ìš©í•  ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ê°€ì ¸ì˜¤ê¸°
 * - Script Propertiesì˜ SPREADSHEET_ID ë˜ëŠ” DEFAULT_SPREADSHEET_ID ì‚¬ìš© â†’ ë„ë©´ë³´ê´€í•¨ê³¼ êµ¬ê¸€ì‹œíŠ¸ ì¼ì¹˜
 */
function getSpreadsheet_() {
  try {
    var id = PropertiesService.getScriptProperties().getProperty('SPREADSHEET_ID') || (typeof DEFAULT_SPREADSHEET_ID !== 'undefined' ? DEFAULT_SPREADSHEET_ID : '');
    if (id && String(id).trim()) {
      return SpreadsheetApp.openById(String(id).trim());
    }
  } catch (e) {}
  try {
    return SpreadsheetApp.getActiveSpreadsheet();
  } catch (e2) {}
  return null;
}

/** ì‹œíŠ¸ëª… ì•ˆì „ ì²˜ë¦¬ */
function sanitizeSheetName_(name) {
  name = String(name || '').trim();
  if (!name) name = 'ë¯¸ì§€ì •_í˜„ì¥';

  // ì‹œíŠ¸ëª… ê¸ˆì§€ ë¬¸ì ì œê±° : \ / ? * [ ]
  name = name.replace(/[:\\\/\?\*\[\]]/g, ' ');
  name = name.replace(/\s+/g, ' ').trim();

  // Google Sheets ì‹œíŠ¸ëª… ìµœëŒ€ 100ì
  if (name.length > 100) name = name.slice(0, 100).trim();

  return name || 'ë¯¸ì§€ì •_í˜„ì¥';
}

/** âœ… ê°™ì€ ì´ë¦„ ì¶©ëŒ ì‹œ (2), (3) ë¶™ì—¬ì„œ ê³ ìœ  ì‹œíŠ¸ëª… ë§Œë“¤ê¸° */
function getUniqueSheetName_(ss, baseName) {
  let name = baseName;
  let n = 2;
  while (ss.getSheetByName(name)) {
    name = `${baseName}(${n})`;
    n++;
    if (name.length > 100) {
      // ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ baseNameì„ ì¤„ì—¬ì„œ ë¶™ì„
      const cut = Math.max(1, 100 - String(`(${n})`).length);
      baseName = baseName.slice(0, cut).trim();
      name = `${baseName}(${n})`;
    }
  }
  return name;
}

/** KST ì‹œê°„ í¬ë§· */
function formatNowKST_() {
  return Utilities.formatDate(new Date(), 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss');
}

/** ë„ë©´ ë³´ê´€í•¨ ì‹œíŠ¸ ì´ë¦„ (í•œ ì‹œíŠ¸ì—ì„œ ëª¨ë‘ ê´€ë¦¬) */
const DRAWING_SHEET_NAME = 'ë„ë©´ë³´ê´€í•¨';

/** âœ… 'ë„ë©´ë³´ê´€í•¨' ë˜ëŠ” 'ë„ë©´ ë³´ê´€í•¨' ì‹œíŠ¸ ì°¾ê¸° (ë„ì–´ì“°ê¸° ìœ ë¬´ + ìœ ì‚¬ ì´ë¦„ ì§€ì›) */
function getDrawingSheet_(ss) {
  var s = ss.getSheetByName('ë„ë©´ë³´ê´€í•¨') || ss.getSheetByName('ë„ë©´ ë³´ê´€í•¨');
  if (s) return s;
  var all = ss.getSheets();
  for (var i = 0; i < all.length; i++) {
    var name = all[i].getName();
    if (name.indexOf('ë„ë©´') !== -1 && name.indexOf('ë³´ê´€') !== -1) return all[i];
  }
  return null;
}

/**
 * âœ… ì €ì¥: "ë„ë©´ë³´ê´€í•¨" ì‹œíŠ¸ í•˜ë‚˜ì— í–‰ìœ¼ë¡œ ì¶”ê°€ (í•œ ì‹œíŠ¸ì—ì„œ ëª¨ë‘ ê´€ë¦¬)
 * - dataëŠ” ë¬¸ìì—´(JSON)ë¡œ ë“¤ì–´ì˜´
 */
function saveToSheet(data) {
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);

  try {
    const ss = getSpreadsheet_();
    const jsonData = JSON.parse(data);

    const rawSiteName = String(jsonData.siteName || '').trim();
    let sheet = getDrawingSheet_(ss);

    if (!sheet) {
      sheet = ss.insertSheet(DRAWING_SHEET_NAME, ss.getNumSheets());
      sheet.appendRow(["ì €ì¥ì‹œê°", "í˜„ì¥ëª…", "ì²œì¥ê³ ", "ìš”ì•½", "ë°ì´í„°(JSON)"]);
      sheet.getRange(1, 1, 1, 5).setBackground('#1a1a1a').setFontColor('#fff').setFontWeight('bold');
      for (let c = 1; c <= 5; c++) sheet.setColumnWidth(c, 150);
    }
    if (sheet.getLastRow() === 0) {
      sheet.appendRow(["ì €ì¥ì‹œê°", "í˜„ì¥ëª…", "ì²œì¥ê³ ", "ìš”ì•½", "ë°ì´í„°(JSON)"]);
      sheet.getRange(1, 1, 1, 5).setBackground('#1a1a1a').setFontColor('#fff').setFontWeight('bold');
    }

    const ts = formatNowKST_();
    jsonData.date = ts;

    const zonesCount = jsonData.zones ? jsonData.zones.length : 0;
    const wallsCount = jsonData.freeWalls ? jsonData.freeWalls.length : 0;
    const furnCount  = jsonData.furnitureLines ? jsonData.furnitureLines.length : 0;
    const doorsCount = jsonData.doors ? jsonData.doors.length : 0;
    const summary = `êµ¬ì—­ ${zonesCount} / ë²½ì„  ${wallsCount} / ê°€êµ¬ ${furnCount} / ë¬¸ ${doorsCount}`;
    const payload = JSON.stringify(jsonData);

    if (payload.length > 45000) {
      return `âŒ ì €ì¥ ì‹¤íŒ¨: ë„ë©´ ë°ì´í„°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤(JSON ${payload.length}ì).
- êµ¬ì—­:${zonesCount} ë²½ì„ :${wallsCount} ê°€êµ¬:${furnCount} ë¬¸:${doorsCount}
- íŒ: êµ¬ì—­/ë²½ì„  ê°œìˆ˜ë¥¼ ì¤„ì´ê±°ë‚˜ ì €ì¥ ë°©ì‹ì„ ë¶„ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.`;
    }

    sheet.appendRow([ts, rawSiteName, jsonData.height || '', summary, payload]);
    return `âœ… ë„ë©´ë³´ê´€í•¨ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`;
  } catch (e) {
    return "âŒ ì˜¤ë¥˜: " + e.toString();
  } finally {
    lock.releaseLock();
  }
}

/**
 * âœ… ê²½ëŸ‰ ëª©ë¡: "ë„ë©´ë³´ê´€í•¨"ì—ì„œ ì»¬ëŸ¼ 1~4(ì €ì¥ì‹œê°, í˜„ì¥ëª…, ì²œì¥ê³ , ìš”ì•½)ë§Œ ì½ì–´ ë°˜í™˜. JSON ì»¬ëŸ¼ ì œì™¸ë¡œ ì²« ë¡œë”© ì „ì†¡ëŸ‰ ëŒ€í­ ê°ì†Œ.
 * - ë„ë©´ë³´ê´€í•¨ì´ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìœ¼ë©´ [] ë°˜í™˜ (í”„ë¡ íŠ¸ì—ì„œ getData() í´ë°± ê°€ëŠ¥).
 */
function getDataList() {
  try {
    const ss = getSpreadsheet_();
    const sheet = getDrawingSheet_(ss);
    if (!sheet || sheet.getLastRow() < 2) return '[]';

    const lastRow = sheet.getLastRow();
    const rows = sheet.getRange(2, 1, lastRow, 4).getValues();
    const bySite = {};
    for (let r = 0; r < rows.length; r++) {
      const row = rows[r];
      const dVal = row[0];
      const siteName = String(row[1] || '').trim();
      const height = row[2];
      const summary = String(row[3] || '').trim();
      const dateStr = (dVal instanceof Date)
        ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
        : String(dVal || '');
      if (!siteName) continue;
      if (!bySite[siteName] || dateStr > String(bySite[siteName].date)) {
        bySite[siteName] = { date: dateStr, siteName: siteName, height: height, summary: summary };
      }
    }
    const list = Object.keys(bySite).map(function(k) { return bySite[k]; });
    list.sort(function(a, b) { return String(b.date || '').localeCompare(String(a.date || '')); });
    return JSON.stringify(list);
  } catch (e) {
    return '[]';
  }
}

/**
 * âœ… í•œ ê±´ ë¡œë“œ: í˜„ì¥ëª…ìœ¼ë¡œ í•´ë‹¹ ë„ë©´ ì „ì²´ JSONë§Œ ê°€ì ¸ì˜¤ê¸° (ì¸ë„¤ì¼/ëª¨ë‹¬ìš©).
 * - ë„ë©´ë³´ê´€í•¨ì— ì—†ìœ¼ë©´ null ë°˜í™˜.
 */
function getDrawingBySiteName(siteName) {
  try {
    const ss = getSpreadsheet_();
    const sheet = getDrawingSheet_(ss);
    if (!sheet || sheet.getLastRow() < 2) return null;

    const rawName = String(siteName || '').trim();
    if (!rawName) return null;

    const lastRow = sheet.getLastRow();
    const rows = sheet.getRange(2, 1, lastRow, 5).getValues();
    let best = null;
    let bestDate = '';
    for (let r = 0; r < rows.length; r++) {
      const row = rows[r];
      const sn = String(row[1] || '').trim();
      if (sn !== rawName) continue;
      const dVal = row[0];
      const jsonStr = row[4];
      if (typeof jsonStr !== 'string' || !jsonStr.trim()) continue;
      const dateStr = (dVal instanceof Date)
        ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
        : String(dVal || '');
      if (dateStr > bestDate) {
        try {
          const item = JSON.parse(jsonStr);
          item.date = dateStr;
          best = item;
          bestDate = dateStr;
        } catch (e) {}
      }
    }
    return best ? JSON.stringify(best) : null;
  } catch (e) {
    return null;
  }
}

/**
 * âœ… ë¶ˆëŸ¬ì˜¤ê¸°: "ë„ë©´ë³´ê´€í•¨" ì‹œíŠ¸ë§Œ ìˆìœ¼ë©´ ê·¸ ì‹œíŠ¸ë§Œ ì½ì–´ì„œ ë°˜í™˜ (API 1íšŒ). ì—†ìœ¼ë©´ ì˜ˆì „ í˜„ì¥ë³„ ì‹œíŠ¸ ìˆœíšŒ.
 */
function getData() {
  try {
    const ss = getSpreadsheet_();
    const bySite = {};
    const sheet = getDrawingSheet_(ss);

    if (sheet && sheet.getLastRow() >= 2) {
      const lastRow = sheet.getLastRow();
      const rows = sheet.getRange(2, 1, lastRow, 5).getValues();
      for (let r = 0; r < rows.length; r++) {
        const row = rows[r];
        const dVal = row[0];
        const siteName = String(row[1] || '').trim();
        const jsonStr = row[4];
        if (typeof jsonStr !== 'string' || !jsonStr.trim()) continue;
        try {
          const item = JSON.parse(jsonStr);
          item.date = (dVal instanceof Date)
            ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
            : String(dVal || '');
          if (!bySite[siteName] || String(item.date) > String(bySite[siteName].date)) {
            bySite[siteName] = item;
          }
        } catch (e) {}
      }
      const list = Object.keys(bySite).map(function(k) { return bySite[k]; });
      list.sort(function(a, b) { return String(b.date || '').localeCompare(String(a.date || '')); });
      return JSON.stringify(list);
    }

    // ë„ë©´ë³´ê´€í•¨ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìŒ: ì˜ˆì „ ë°©ì‹(í˜„ì¥ë³„ ì‹œíŠ¸)ìœ¼ë¡œ ì½ê¸°
    const sheets = ss.getSheets();
    for (let i = 0; i < sheets.length; i++) {
      const s = sheets[i];
      const name = s.getName();
      if (name.indexOf('(í’ˆëª©)') !== -1 || name.indexOf('ê²¬ì _') === 0) continue;
      const lastRow = s.getLastRow();
      if (lastRow < 2) continue;
      const row = s.getRange(lastRow, 1, 1, 5).getValues()[0];
      const dVal = row[0];
      const jsonStr = row[4];
      if (typeof jsonStr !== 'string' || !jsonStr.trim()) continue;
      try {
        const item = JSON.parse(jsonStr);
        const siteName = String(item.siteName || row[1] || '').trim();
        item.date = (dVal instanceof Date)
          ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
          : String(dVal || '');
        if (!bySite[siteName] || String(item.date) > String(bySite[siteName].date)) {
          bySite[siteName] = item;
        }
      } catch (e) {}
    }
    const list = Object.keys(bySite).map(function(k) { return bySite[k]; });
    list.sort(function(a, b) { return String(b.date || '').localeCompare(String(a.date || '')); });
    return JSON.stringify(list);
  } catch (e) {
    return "[]";
  }
}

/** í˜„ì¥ëª… ë¹„êµìš© ì •ê·œí™” (ê³µë°±Â·íƒ€ì… í†µì¼) */
function normalizeSiteName_(val) {
  if (val == null) return '';
  var s = String(val).trim();
  s = s.replace(/\s+/g, ' ').trim();
  return s;
}

/**
 * âœ… ë„ë©´ë³´ê´€í•¨ ì—°ê²° ìƒíƒœ ì§„ë‹¨ (ìŠ¤í¬ë¦½íŠ¸ ì—ë””í„°ì—ì„œ ì‹¤í–‰í•˜ê±°ë‚˜ ì›¹ì•±ì—ì„œ í˜¸ì¶œ)
 * - ì‚¬ìš© ì¤‘ì¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì´ë¦„/ID, ì‹œíŠ¸ ì´ë¦„, Bì—´(í˜„ì¥ëª…) ìƒ˜í”Œ ë°˜í™˜
 */
function getDrawingStorageDiagnostics() {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return "âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Script Propertiesì— SPREADSHEET_IDë¥¼ ë„£ê±°ë‚˜, ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹œíŠ¸ì— ì—°ê²°í•˜ì„¸ìš”.";
    var sheet = getDrawingSheet_(ss);
    if (!sheet) {
      var names = ss.getSheets().map(function(s) { return s.getName(); });
      return "ìŠ¤í”„ë ˆë“œì‹œíŠ¸: " + ss.getName() + " (ID: " + ss.getId() + ")\n\n'ë„ë©´ë³´ê´€í•¨' ì‹œíŠ¸ ì—†ìŒ. í˜„ì¬ ì‹œíŠ¸ ëª©ë¡: " + names.join(', ');
    }
    var lastRow = sheet.getLastRow();
    var out = "ìŠ¤í”„ë ˆë“œì‹œíŠ¸: " + ss.getName() + " (ID: " + ss.getId() + ")\nì‹œíŠ¸: " + sheet.getName() + "\në°ì´í„° í–‰ ìˆ˜: " + (lastRow >= 2 ? lastRow - 1 : 0);
    if (lastRow >= 2) {
      var data = sheet.getRange(2, 1, Math.min(lastRow, 6), 2).getValues();
      out += "\n\nBì—´(í˜„ì¥ëª…) ìƒ˜í”Œ:\n";
      for (var i = 0; i < data.length; i++) {
        out += "  " + (i + 2) + "í–‰: \"" + String(data[i][1] || '').trim() + "\"\n";
      }
    }
    return out;
  } catch (e) {
    return "ì§„ë‹¨ ì˜¤ë¥˜: " + (e.toString ? e.toString() : String(e));
  }
}

/**
 * âœ… ì—°ê²° ì•ˆëœ í•­ëª© ì •ë¦¬: ë„ë©´ë³´ê´€í•¨ì—ì„œ í˜„ì¥ë³„ "ìµœì‹  1í–‰"ë§Œ ë‚¨ê¸°ê³ , ê°™ì€ í˜„ì¥ì˜ ë‚˜ë¨¸ì§€(ì¤‘ë³µÂ·ì˜¤ë˜ëœ) í–‰ ì‚­ì œ
 * - ëª©ë¡ì— ë³´ì´ëŠ” í•­ëª© = í˜„ì¥ë‹¹ ìµœì‹  1ê±´ì´ë¯€ë¡œ, ê·¸ì— ë§ì¶° ì‹œíŠ¸ë¥¼ ì •ë¦¬
 */
function deleteUnconnectedDrawingRows() {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(15000);
  } catch (lockErr) {
    return "âŒ ì •ë¦¬ ëŒ€ê¸° ì¤‘ ì˜¤ë¥˜: " + (lockErr.message || lockErr);
  }
  try {
    var ss = getSpreadsheet_();
    if (!ss) return "âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    var sheet = getDrawingSheet_(ss);
    if (!sheet) return "âŒ 'ë„ë©´ë³´ê´€í•¨' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return "âœ… ì •ë¦¬í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    var data = sheet.getRange(2, 1, lastRow, 2).getValues();
    // í˜„ì¥ëª…ë³„ë¡œ "ìµœì‹  ë‚ ì§œ"ì¸ í–‰ ë²ˆí˜¸ë§Œ ë‚¨ê¸¸ ê²ƒ (ê·¸ í–‰ì€ ìœ ì§€)
    var keepRowBySite = {};
    for (var r = 0; r < data.length; r++) {
      var siteName = normalizeSiteName_(data[r][1]);
      if (!siteName) continue;
      var rowNum = r + 2;
      var dVal = data[r][0];
      var dateStr = (dVal instanceof Date)
        ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
        : String(dVal || '');
      if (!keepRowBySite[siteName] || dateStr > keepRowBySite[siteName].date) {
        keepRowBySite[siteName] = { row: rowNum, date: dateStr };
      }
    }
    var toDelete = [];
    for (var r = 0; r < data.length; r++) {
      var siteName = normalizeSiteName_(data[r][1]);
      if (!siteName) continue;
      var rowNum = r + 2;
      var keep = keepRowBySite[siteName];
      if (keep && keep.row === rowNum) continue;
      toDelete.push(rowNum);
    }
    if (toDelete.length === 0) {
      return "âœ… í˜„ì¥ë³„ë¡œ ì´ë¯¸ 1ê±´ì”©ë§Œ ìˆì–´ì„œ ì •ë¦¬í•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤.";
    }
    toDelete.sort(function(a, b) { return b - a; });
    for (var i = 0; i < toDelete.length; i++) {
      sheet.deleteRow(toDelete[i]);
    }
    SpreadsheetApp.flush();
    return "âœ… ì—°ê²° ì•ˆ ëœ(ì¤‘ë³µÂ·ì˜¤ë˜ëœ) í•­ëª© " + toDelete.length + "ê±´ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.";
  } catch (e) {
    return "âŒ ì •ë¦¬ ì˜¤ë¥˜: " + (e.toString ? e.toString() : String(e));
  } finally {
    try { lock.releaseLock(); } catch (e2) {}
  }
}

/**
 * âœ… ì‚­ì œ: "ë„ë©´ë³´ê´€í•¨" ì‹œíŠ¸ì—ì„œ í•´ë‹¹ í˜„ì¥ëª…ê³¼ ì¼ì¹˜í•˜ëŠ” í–‰ì„ ëª¨ë‘ ì‚­ì œ
 * - Bì—´(í˜„ì¥ëª…)ì„ ì •ê·œí™”í•´ì„œ ë¹„êµí•˜ì—¬ ì¼ì¹˜í•˜ëŠ” í–‰ë§Œ ì•„ë˜ìª½ë¶€í„° deleteRow
 * - "ë„ë©´ë³´ê´€í•¨" ì—†ìœ¼ë©´ ì˜ˆì „ ë°©ì‹(í˜„ì¥ë³„ ì‹œíŠ¸ ë§ˆì§€ë§‰ í–‰ ì‚­ì œ)ìœ¼ë¡œ ì²˜ë¦¬
 */
function deleteFromSheet(siteName) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000);
  } catch (lockErr) {
    return "âŒ ì‚­ì œ ëŒ€ê¸° ì¤‘ ì˜¤ë¥˜: " + (lockErr.message || lockErr);
  }

  try {
    var ss = getSpreadsheet_();
    if (!ss) return "âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Apps Script í”„ë¡œì íŠ¸ ì„¤ì • â†’ ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì— SPREADSHEET_ID(êµ¬ê¸€ ì‹œíŠ¸ URLì˜ /d/ ì™€ /edit ì‚¬ì´ ê°’)ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”.";
    var rawName = normalizeSiteName_(siteName);
    if (!rawName) return "âŒ í˜„ì¥ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";

    var sheet = getDrawingSheet_(ss);
    if (!sheet) return "âŒ 'ë„ë©´ë³´ê´€í•¨' ë˜ëŠ” 'ë„ë©´ ë³´ê´€í•¨' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‹œíŠ¸ íƒ­ ì´ë¦„ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";

    var lastRow = sheet.getLastRow();
    if (lastRow >= 2) {
      // Aì—´(ì €ì¥ì‹œê°), Bì—´(í˜„ì¥ëª…)ë§Œ ì½ê¸°. í–‰ ì¸ë±ìŠ¤ 1-based
      var data = sheet.getRange(2, 1, lastRow, 2).getValues();
      var toDelete = [];
      for (var r = 0; r < data.length; r++) {
        var cellB = data[r][1];
        var rowName = normalizeSiteName_(cellB);
        if (rowName !== rawName) continue;
        toDelete.push(r + 2);
      }
      if (toDelete.length > 0) {
        toDelete.sort(function(a, b) { return b - a; });
        for (var i = 0; i < toDelete.length; i++) {
          sheet.deleteRow(toDelete[i]);
        }
        SpreadsheetApp.flush();
        return "âœ… '" + rawName + "' ë„ë©´ " + toDelete.length + "ê±´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
      }
      // ì¼ì¹˜í•˜ëŠ” í–‰ ì—†ìŒ â†’ ì›ì¸ íŒŒì•…ìš© ë©”ì‹œì§€
      var sampleB = [];
      for (var s = 0; s < Math.min(5, data.length); s++) {
        sampleB.push('"' + String(data[s][1] || '').trim() + '"');
      }
      return "âŒ '" + rawName + "'ì™€(ê³¼) ì¼ì¹˜í•˜ëŠ” í–‰ì´ ì—†ìŠµë‹ˆë‹¤.\n\n[ì„œë²„ í™•ì¸]\nìŠ¤í”„ë ˆë“œì‹œíŠ¸: " + ss.getName() + "\nì‹œíŠ¸: " + sheet.getName() + "\në°ì´í„° í–‰ ìˆ˜: " + (lastRow - 1) + "\nBì—´ ìƒ˜í”Œ(ì²˜ìŒ 5ê°œ): " + sampleB.join(', ') + "\n\nâ†’ ìŠ¤í”„ë ˆë“œì‹œíŠ¸/ì‹œíŠ¸ê°€ ë§ëŠ”ì§€, Bì—´ì´ í˜„ì¥ëª…ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.";
    }

    // ì˜ˆì „ ë°©ì‹: í˜„ì¥ëª…ìœ¼ë¡œ ëœ ì‹œíŠ¸ì—ì„œ ë§ˆì§€ë§‰ í–‰ ì‚­ì œ
    var baseName = sanitizeSheetName_(rawName);
    var oldSheet = ss.getSheetByName(baseName);
    if (!oldSheet) return "âŒ '" + rawName + "' ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    var oldLastRow = oldSheet.getLastRow();
    if (oldLastRow < 2) return "âŒ ì‚­ì œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    oldSheet.deleteRow(oldLastRow);
    if (oldSheet.getLastRow() < 2) ss.deleteSheet(oldSheet);
    SpreadsheetApp.flush();
    return "âœ… '" + rawName + "' ë„ë©´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
  } catch (e) {
    return "âŒ ì‚­ì œ ì˜¤ë¥˜: " + (e.toString ? e.toString() : String(e));
  } finally {
    try { lock.releaseLock(); } catch (e2) {}
  }
}

// ========================================
// ê²¬ì ì„œ ê´€ë ¨ í•¨ìˆ˜
// ========================================

/** ë‹¨ê°€í‘œ ìºì‹œ í‚¤ (CacheService, TTL 180ì´ˆ) */
var PRICE_TABLES_CACHE_KEY = 'priceTables';
var PRICE_TABLES_CACHE_TTL = 180;

/**
 * ğŸ“Š ëª¨ë“  ë‹¨ê°€í‘œ ì½ê¸°
 * - ìºì‹œ ìˆìœ¼ë©´ ì¦‰ì‹œ ë°˜í™˜(ì‹œíŠ¸ ì½ê¸° 0íšŒ). ì—†ìœ¼ë©´ (í’ˆëª©) ì‹œíŠ¸ ì½ì–´ì„œ ìºì‹œ í›„ ë°˜í™˜.
 */
function getAllPriceTables() {
  try {
    const cache = CacheService.getScriptCache();
    const cached = cache.get(PRICE_TABLES_CACHE_KEY);
    if (cached != null) return cached;

    const ss = getSpreadsheet_();
    const sheets = ss.getSheets();
    const result = {};

    sheets.forEach(sheet => {
      const name = sheet.getName();
      if (name.includes('(í’ˆëª©)')) {
        const category = name.replace('(í’ˆëª©)', '').trim();
        const data = sheet.getDataRange().getValues();
        const items = [];
        let hasMaejiSub = false;
        for (let i = 1; i < data.length; i++) {
          const row = data[i];
          if (row[0]) {
            const itemName = String(row[0] || '');
            if (category === 'í™”ì¥ì‹¤ê³µì‚¬' && itemName === 'ë§¤ì§€ ë¶€ìì¬') {
              hasMaejiSub = true;
            }
            items.push({
              item: itemName,
              spec: String(row[1] || ''),
              unit: String(row[2] || ''),
              materialPrice: Number(row[3] || 0),
              laborPrice: Number(row[4] || 0)
            });
          }
        }

        // í™”ì¥ì‹¤ê³µì‚¬(í’ˆëª©)ì— 'ë§¤ì§€ ë¶€ìì¬'ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ í•œ ì¤„ ì¶”ê°€
        if (category === 'í™”ì¥ì‹¤ê³µì‚¬' && !hasMaejiSub) {
          const newRow = ['ë§¤ì§€ ë¶€ìì¬', '', 'í¬', 0, 0];
          sheet.appendRow(newRow);
          items.push({
            item: newRow[0],
            spec: newRow[1],
            unit: newRow[2],
            materialPrice: newRow[3],
            laborPrice: newRow[4]
          });
        }

        // êµ¬ ë„ë°°í•„ë¦„ê³µì‚¬(í’ˆëª©) ì‹œíŠ¸: í•­ëª©ì„ ë„ë°°ê³µì‚¬/í•„ë¦„ê³µì‚¬ë¡œ ë‚˜ëˆ„ì–´ ì±„ì›€
        if (category === 'ë„ë°°í•„ë¦„ê³µì‚¬' && items.length > 0) {
          const ë„ë°°í’ˆëª© = ['ë„ë°°', 'ì‹¤í¬', 'ì¹œí™˜ê²½ë„ë°°', 'ë„ë°° ìì¬ë¹„ - í•©ì§€', 'ë„ë°° ìì¬ë¹„ - ì‹¤í¬', 'ë„ë°° ìì¬ë¹„ - ë””ì•„ë§', 'ë„ë°° ë¶€ìì¬', 'ë„ë°° ì¸ê±´ë¹„'];
          const ë„ë°°Items = items.filter(it => ë„ë°°í’ˆëª©.indexOf(it.item) !== -1);
          const í•„ë¦„Items = items.filter(it => ë„ë°°í’ˆëª©.indexOf(it.item) === -1);
          if (ë„ë°°Items.length > 0) result['ë„ë°°ê³µì‚¬'] = ë„ë°°Items;
          if (í•„ë¦„Items.length > 0) result['í•„ë¦„ê³µì‚¬'] = í•„ë¦„Items;
        } else if (items.length > 0) {
          result[category] = items;
        }
      }
    });

    const json = JSON.stringify(result);
    cache.put(PRICE_TABLES_CACHE_KEY, json, PRICE_TABLES_CACHE_TTL);
    return json;
  } catch (e) {
    return JSON.stringify({ error: e.toString() });
  }
}

/**
 * ğŸ’¾ ê²¬ì ì„œ ì €ì¥
 * - estimateData: JSON ë¬¸ìì—´
 *   { siteName, area, items: [...], subtotal, overhead, profit, vat, total }
 */
function saveEstimate(estimateData) {
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);

  try {
    const ss = getSpreadsheet_();
    const data = JSON.parse(estimateData);
    
    const sheetName = 'ê²¬ì _' + sanitizeSheetName_(data.siteName);
    let sheet = ss.getSheetByName(sheetName);
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„± (ë®ì–´ì“°ê¸°)
    if (sheet) {
      ss.deleteSheet(sheet);
    }
    
    sheet = ss.insertSheet(sheetName);
    
    // ì—´ ë„ˆë¹„ ì „ì²´ 150px
    for (let col = 1; col <= sheet.getMaxColumns(); col++) {
      sheet.setColumnWidth(col, 150);
    }
    
    // í—¤ë” ì •ë³´
    sheet.appendRow(['ê²¬ì ì„œ']);
    sheet.appendRow(['í˜„ì¥ëª…:', data.siteName, 'í‰ìˆ˜:', data.area + 'í‰']);
    sheet.appendRow(['ì‘ì„±ì¼:', formatNowKST_()]);
    sheet.appendRow(['']); // ë¹ˆ í–‰
    
    // í…Œì´ë¸” í—¤ë”
    sheet.appendRow(['No', 'í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ìˆ˜ëŸ‰', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ì¬ë£Œë¹„ê¸ˆì•¡', 'ë…¸ë¬´ë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ê¸ˆì•¡', 'ê¸ˆì•¡']);
    const headerRow = sheet.getLastRow();
    
    // ê³µì • ìˆœì„œ (ëŒ€ì œëª© + í•˜ìœ„ í’ˆëª©)
    const categoryOrder = ['ê°€ì„¤ì² ê±°', 'ëª©ê³µì‚¬', 'ì „ê¸°ê³µì‚¬', 'ì„¤ë¹„ê³µì‚¬', 'í™”ì¥ì‹¤ê³µì‚¬', 'ë„ë°°ê³µì‚¬', 'í•„ë¦„ê³µì‚¬', 'ë°”ë‹¥ê³µì‚¬', 'ì‹±í¬ê°€êµ¬ê³µì‚¬', 'ë„ì¥ê³µì‚¬', 'ê¸ˆì†ìœ ë¦¬ê³µì‚¬', 'ê¸°íƒ€ê³µì‚¬'];
    const byCategory = {};
    data.items.forEach(function(item) {
      if (!byCategory[item.category]) byCategory[item.category] = [];
      byCategory[item.category].push(item);
    });
    
    const sectionRows = [];
    const subtotalRows = [];
    let no = 0;
    categoryOrder.forEach(function(cat) {
      const items = byCategory[cat];
      if (!items || items.length === 0) return;
      sheet.appendRow(['', 'â–  ' + cat, '', '', '', '', '', '', '', '']);
      sectionRows.push(sheet.getLastRow());
      let catSum = 0;
      items.forEach(function(item) {
        no++;
        catSum += Number(item.totalAmount) || 0;
        sheet.appendRow([
          no,
          item.item,
          item.spec,
          item.unit,
          item.qty,
          item.materialPrice,
          item.materialAmount,
          item.laborPrice,
          item.laborAmount,
          item.totalAmount
        ]);
      });
      sheet.appendRow(['', cat + ' ì†Œê³„', '', '', '', '', '', '', '', catSum]);
      subtotalRows.push(sheet.getLastRow());
    });
    
    // í•©ê³„
    sheet.appendRow(['']);
    sheet.appendRow(['', '', '', '', '', '', '', '', 'ì†Œê³„', data.subtotal]);
    sheet.appendRow(['', '', '', '', '', '', '', '', 'ê³µê³¼ì¡ë¹„(5%)', data.overhead]);
    sheet.appendRow(['', '', '', '', '', '', '', '', 'ì´ìœ¤(10%)', data.profit]);
    sheet.appendRow(['', '', '', '', '', '', '', '', 'ì¡°ì •ì•¡', data.adjusted]);
    sheet.appendRow(['', '', '', '', '', '', '', '', 'ì´ì•¡ (VAT ë³„ë„)', data.total]);
    const totalRow = sheet.getLastRow();
    
    // ë¯¸ë¦¬ë³´ê¸°ì²˜ëŸ¼ ìƒ‰ìƒ ì ìš©
    sheet.getRange(headerRow, 1, headerRow, 10).setBackground('#eeeeee').setFontWeight('bold');
    sectionRows.forEach(function(r) {
      sheet.getRange(r, 1, r, 10).setBackground('#e0e0e0').setFontWeight('bold');
    });
    subtotalRows.forEach(function(r) {
      sheet.getRange(r, 1, r, 10).setBackground('#f5f5f5').setFontWeight('bold');
    });
    sheet.getRange(totalRow - 4, 1, totalRow, 10).setBackground('#f9f9f9');
    sheet.getRange(totalRow, 9, totalRow, 10).setFontWeight('bold').setBackground('#fff3cd');
    
    return `âœ… '${sheetName}' ì‹œíŠ¸ì— ê²¬ì ì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`;
  } catch (e) {
    return "âŒ ê²¬ì ì„œ ì €ì¥ ì˜¤ë¥˜: " + e.toString();
  } finally {
    lock.releaseLock();
  }
}

/**
 * ì‹œíŠ¸ì— ì €ì¥ëœ ê²¬ì  ëª©ë¡ (ê²¬ì _ ì‹œíŠ¸ê°€ ìˆëŠ” í˜„ì¥ëª…)
 * - ë°˜í™˜: JSON ë¬¸ìì—´ ë°°ì—´ ["í˜„ì¥A", "í˜„ì¥B", ...]
 */
function getEstimateList() {
  return getScheduleList();
}

/**
 * ê²¬ì _í˜„ì¥ëª… ì‹œíŠ¸ì—ì„œ ê²¬ì  ë°ì´í„° ì½ì–´ì„œ í´ë¼ì´ì–¸íŠ¸ìš© JSON ë°˜í™˜
 * - ë°˜í™˜: JSON ë¬¸ìì—´ { siteName, area, items: [...], subtotal, overhead, profit, adjusted, total }
 */
function getEstimateFromSheet(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return null;
    var sheetName = 'ê²¬ì _' + sanitizeSheetName_(String(siteName || '').trim());
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return null;
    var lastRow = sheet.getLastRow();
    if (lastRow < 8) return null;
    var data = sheet.getRange(1, 1, lastRow, 10).getValues();
    var siteNameVal = String((data[1] && data[1][1]) ? data[1][1] : siteName).trim();
    var areaVal = 0;
    if (data[1] && data[1][3]) {
      var a = String(data[1][3]).replace(/í‰/g, '').trim();
      if (a && !isNaN(Number(a))) areaVal = Number(a);
    }
    var headerRowIndex = -1;
    for (var h = 0; h < Math.min(15, data.length); h++) {
      if (String(data[h][0] || '').trim() === 'No') { headerRowIndex = h; break; }
    }
    if (headerRowIndex < 0) return null;
    var items = [];
    var currentCat = null;
    var subtotal = 0, overhead = 0, profit = 0, adjusted = 0, total = 0;
    for (var r = headerRowIndex + 1; r < data.length; r++) {
      var row = data[r];
      var a = row[0], b = String(row[1] || '').trim(), col9 = String(row[8] || '').trim(), col10 = row[9];
      if (b.indexOf('â– ') === 0) {
        currentCat = b.replace(/^â– \s*/, '').trim();
        continue;
      }
      if (b.indexOf(' ì†Œê³„') !== -1) { currentCat = null; continue; }
      if (col9 === 'ì†Œê³„') { subtotal = Number(col10) || 0; continue; }
      if (col9.indexOf('ê³µê³¼ì¡ë¹„') !== -1) { overhead = Number(col10) || 0; continue; }
      if (col9.indexOf('ì´ìœ¤') !== -1) { profit = Number(col10) || 0; continue; }
      if (col9.indexOf('ì¡°ì •ì•¡') !== -1) { adjusted = Number(col10) || 0; continue; }
      if (col9.indexOf('ì´ì•¡') !== -1) { total = Number(col10) || 0; continue; }
      if (currentCat && a !== '' && a != null && !isNaN(Number(a))) {
        items.push({
          category: currentCat,
          item: b,
          spec: String(row[2] || ''),
          unit: String(row[3] || ''),
          qty: row[4] != null && row[4] !== '' ? Number(row[4]) : 0,
          materialPrice: Number(row[5]) || 0,
          materialAmount: Number(row[6]) || 0,
          laborPrice: Number(row[7]) || 0,
          laborAmount: Number(row[8]) || 0,
          totalAmount: Number(row[9]) || 0
        });
      }
    }
    var out = {
      siteName: siteNameVal,
      area: areaVal,
      items: items,
      subtotal: subtotal,
      overhead: overhead,
      profit: profit,
      adjusted: adjusted,
      total: total
    };
    return JSON.stringify(out);
  } catch (e) {
    return null;
  }
}

// ========================================
// ì¼ì • ê´€ë ¨ í•¨ìˆ˜
// ========================================

const SCHEDULE_SHEET_NAME = 'ì¼ì •';

/** ì¼ì • ì‹œíŠ¸ ê°€ì ¸ì˜¤ê¸°. ì—†ìœ¼ë©´ í—¤ë”ì™€ í•¨ê»˜ ìƒì„± */
function getOrCreateScheduleSheet_(ss) {
  var sheet = ss.getSheetByName(SCHEDULE_SHEET_NAME);
  if (sheet) return sheet;
  sheet = ss.insertSheet(SCHEDULE_SHEET_NAME, ss.getNumSheets());
  sheet.appendRow(['í˜„ì¥ëª…', 'ê³µì •', 'ì‹œì‘ì¼', 'ì¢…ë£Œì¼', 'ë¹„ê³ ']);
  sheet.getRange(1, 1, 1, 5).setFontWeight('bold');
  return sheet;
}

/**
 * ì¼ì •ì„ ë§Œë“¤ ìˆ˜ ìˆëŠ” í˜„ì¥ ëª©ë¡ (ê²¬ì _ ì‹œíŠ¸ê°€ ìˆëŠ” í˜„ì¥ëª…)
 * - ë°˜í™˜: JSON ë¬¸ìì—´ ë°°ì—´ ["í˜„ì¥A", "í˜„ì¥B", ...]
 */
function getScheduleList() {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return JSON.stringify([]);
    var names = ss.getSheets().map(function(s) { return s.getName(); });
    var list = [];
    var prefix = 'ê²¬ì _';
    for (var i = 0; i < names.length; i++) {
      if (names[i].indexOf(prefix) === 0) {
        var siteName = names[i].slice(prefix.length).trim();
        if (siteName && list.indexOf(siteName) === -1) list.push(siteName);
      }
    }
    list.sort();
    return JSON.stringify(list);
  } catch (e) {
    return JSON.stringify([]);
  }
}

/**
 * í•´ë‹¹ í˜„ì¥ì˜ ì¼ì • ì¡°íšŒ
 * - ë°˜í™˜: JSON ë¬¸ìì—´ [{ category, startDate, endDate, memo }, ...]
 */
function getSchedule(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return JSON.stringify([]);
    var sheet = getOrCreateScheduleSheet_(ss);
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) return JSON.stringify([]);
    var data = sheet.getRange(2, 1, lastRow, 5).getValues();
    var rawName = String(siteName || '').trim();
    var result = [];
    for (var r = 0; r < data.length; r++) {
      var row = data[r];
      if (String(row[0] || '').trim() !== rawName) continue;
      result.push({
        category: String(row[1] || ''),
        startDate: String(row[2] || '').trim(),
        endDate: String(row[3] || '').trim(),
        memo: String(row[4] || '').trim()
      });
    }
    return JSON.stringify(result);
  } catch (e) {
    return JSON.stringify([]);
  }
}

/**
 * ì¼ì • + ê³µì •ë³„ ë…¸ë¬´ë¹„Â·ì¬ë£Œë¹„ í•œ ë²ˆì— ì¡°íšŒ (ì¼ì • í™”ë©´ ë¶ˆëŸ¬ì˜¤ê¸° 1íšŒ í˜¸ì¶œìš©)
 * - ë°˜í™˜: JSON ë¬¸ìì—´ { schedule: [...], labor: {...}, material: {...} }
 */
function getScheduleWithLaborAndMaterial(siteName) {
  var scheduleJson = getSchedule(siteName);
  var combinedJson = getEstimateLaborAndMaterialByCategory(siteName);
  try {
    var schedule = JSON.parse(scheduleJson || '[]');
    var combined = JSON.parse(combinedJson || '{}');
    return JSON.stringify({
      schedule: schedule,
      labor: combined.labor || {},
      material: combined.material || {}
    });
  } catch (e) {
    return JSON.stringify({ schedule: [], labor: {}, material: {} });
  }
}

/**
 * í•´ë‹¹ í˜„ì¥ì˜ ì¼ì • ì €ì¥ (ê¸°ì¡´ í–‰ ì‚­ì œ í›„ ì¶”ê°€)
 * - scheduleData: JSON ë¬¸ìì—´. ë°°ì—´ [{ category, startDate, endDate, memo }, ...]
 */
function saveSchedule(siteName, scheduleData) {
  var lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000);
  } catch (lockErr) {
    return "âŒ ì¼ì • ì €ì¥ ëŒ€ê¸° ì¤‘ ì˜¤ë¥˜: " + (lockErr.message || lockErr);
  }
  try {
    var ss = getSpreadsheet_();
    if (!ss) return "âŒ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
    var sheet = getOrCreateScheduleSheet_(ss);
    var rawName = String(siteName || '').trim();
    if (!rawName) return "âŒ í˜„ì¥ëª…ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.";

    var data = JSON.parse(scheduleData || '[]');
    var lastRow = sheet.getLastRow();
    if (lastRow >= 2) {
      var allData = sheet.getRange(2, 1, lastRow, 1).getValues();
      var toDelete = [];
      for (var r = 0; r < allData.length; r++) {
        if (String(allData[r][0] || '').trim() === rawName) toDelete.push(r + 2);
      }
      toDelete.sort(function(a, b) { return b - a; });
      for (var i = 0; i < toDelete.length; i++) {
        sheet.deleteRow(toDelete[i]);
      }
    }

    for (var j = 0; j < data.length; j++) {
      var row = data[j];
      sheet.appendRow([
        rawName,
        String(row.category || ''),
        String(row.startDate || '').trim(),
        String(row.endDate || '').trim(),
        String(row.memo || '').trim()
      ]);
    }
    SpreadsheetApp.flush();
    return "âœ… ì¼ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
  } catch (e) {
    return "âŒ ì¼ì • ì €ì¥ ì˜¤ë¥˜: " + (e.toString ? e.toString() : String(e));
  } finally {
    try { lock.releaseLock(); } catch (e2) {}
  }
}

/**
 * ê²¬ì ì„œ ì‹œíŠ¸ì—ì„œ ê³µì •ë³„ ë…¸ë¬´ë¹„(ì¸ê±´ë¹„) í•©ê³„ ì¡°íšŒ
 * - siteNameì— í•´ë‹¹í•˜ëŠ” ê²¬ì _í˜„ì¥ëª… ì‹œíŠ¸ë¥¼ ì½ì–´, â–  ê³µì •ëª… ì„¹ì…˜ë³„ë¡œ ë…¸ë¬´ë¹„ê¸ˆì•¡ í•©ê³„ ë°˜í™˜
 * - ë…¸ë¬´ë¹„ê¸ˆì•¡ ì—´: í—¤ë” í–‰ì—ì„œ "ë…¸ë¬´ë¹„ê¸ˆì•¡" ë˜ëŠ” "ë…¸ë¬´ë¹„" í¬í•¨ ì—´ì„ ì°¾ê³ , ì—†ìœ¼ë©´ 9ì—´(Iì—´) ì‚¬ìš©
 * - ë°˜í™˜: JSON ë¬¸ìì—´ { "ê°€ì„¤ì² ê±°": 80000, "ëª©ê³µì‚¬": 250000, ... }
 */
function getEstimateLaborByCategory(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return JSON.stringify({});
    var sheetName = 'ê²¬ì _' + sanitizeSheetName_(String(siteName || '').trim());
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return JSON.stringify({});
    var lastRow = sheet.getLastRow();
    if (lastRow < 5) return JSON.stringify({});
    var data = sheet.getRange(1, 1, lastRow, 10).getValues();
    var laborColIndex = 8;
    for (var h = 0; h < Math.min(6, data.length); h++) {
      var headerRow = data[h];
      for (var col = 0; col < headerRow.length; col++) {
        var cell = String(headerRow[col] || '').trim();
        if (cell.indexOf('ë…¸ë¬´ë¹„ê¸ˆì•¡') !== -1 || (cell.indexOf('ë…¸ë¬´ë¹„') !== -1 && cell.indexOf('ë‹¨ê°€') === -1)) {
          laborColIndex = col;
          break;
        }
      }
    }
    var result = {};
    var currentCat = null;
    for (var r = 0; r < data.length; r++) {
      var row = data[r];
      var a = row[0];
      var b = String(row[1] || '').trim();
      if (b.indexOf('â– ') === 0) {
        currentCat = b.replace(/^â– \s*/, '').trim();
        if (currentCat) result[currentCat] = 0;
        continue;
      }
      if (currentCat && a !== '' && a !== null && !isNaN(Number(a))) {
        var labor = Number(row[laborColIndex]) || 0;
        result[currentCat] = (result[currentCat] || 0) + labor;
      }
      if (b.indexOf(' ì†Œê³„') !== -1) currentCat = null;
    }
    // êµ¬ ê²¬ì : ë„ë°°í•„ë¦„ê³µì‚¬ í•œ ì„¹ì…˜ â†’ ë„ë°°ê³µì‚¬/í•„ë¦„ê³µì‚¬ë¡œ ë‚˜ëˆ„ì–´ ì¼ì •ì— ë…¸ë¬´ë¹„ í‘œì‹œ
    if (result['ë„ë°°í•„ë¦„ê³µì‚¬'] != null) {
      var v = result['ë„ë°°í•„ë¦„ê³µì‚¬'];
      result['ë„ë°°ê³µì‚¬'] = (result['ë„ë°°ê³µì‚¬'] || 0) + Math.floor(v / 2);
      result['í•„ë¦„ê³µì‚¬'] = (result['í•„ë¦„ê³µì‚¬'] || 0) + (v - Math.floor(v / 2));
      delete result['ë„ë°°í•„ë¦„ê³µì‚¬'];
    }
    return JSON.stringify(result);
  } catch (e) {
    return JSON.stringify({});
  }
}

/**
 * ê²¬ì ì„œ ì‹œíŠ¸ì—ì„œ ê³µì •ë³„ ë…¸ë¬´ë¹„ + ì¬ë£Œë¹„ í•©ê³„ ì¡°íšŒ (ì¼ì • í™”ë©´ìš©)
 * - ë°˜í™˜: JSON ë¬¸ìì—´ { "labor": { "ê°€ì„¤ì² ê±°": 80000, ... }, "material": { "ê°€ì„¤ì² ê±°": 120000, ... } }
 */
function getEstimateLaborAndMaterialByCategory(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return JSON.stringify({ labor: {}, material: {} });
    var sheetName = 'ê²¬ì _' + sanitizeSheetName_(String(siteName || '').trim());
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return JSON.stringify({ labor: {}, material: {} });
    var lastRow = sheet.getLastRow();
    if (lastRow < 5) return JSON.stringify({ labor: {}, material: {} });
    var data = sheet.getRange(1, 1, lastRow, 10).getValues();
    var laborColIndex = 8;
    var materialColIndex = 6;
    for (var h = 0; h < Math.min(6, data.length); h++) {
      var headerRow = data[h];
      for (var col = 0; col < headerRow.length; col++) {
        var cell = String(headerRow[col] || '').trim();
        if (cell.indexOf('ë…¸ë¬´ë¹„ê¸ˆì•¡') !== -1 || (cell.indexOf('ë…¸ë¬´ë¹„') !== -1 && cell.indexOf('ë‹¨ê°€') === -1)) laborColIndex = col;
        if (cell.indexOf('ì¬ë£Œë¹„ê¸ˆì•¡') !== -1 || (cell.indexOf('ì¬ë£Œë¹„') !== -1 && cell.indexOf('ë‹¨ê°€') === -1)) materialColIndex = col;
      }
    }
    var laborResult = {};
    var materialResult = {};
    var currentCat = null;
    for (var r = 0; r < data.length; r++) {
      var row = data[r];
      var a = row[0];
      var b = String(row[1] || '').trim();
      if (b.indexOf('â– ') === 0) {
        currentCat = b.replace(/^â– \s*/, '').trim();
        if (currentCat) { laborResult[currentCat] = 0; materialResult[currentCat] = 0; }
        continue;
      }
      if (currentCat && a !== '' && a !== null && !isNaN(Number(a))) {
        laborResult[currentCat] = (laborResult[currentCat] || 0) + (Number(row[laborColIndex]) || 0);
        materialResult[currentCat] = (materialResult[currentCat] || 0) + (Number(row[materialColIndex]) || 0);
      }
      if (b.indexOf(' ì†Œê³„') !== -1) currentCat = null;
    }
    if (laborResult['ë„ë°°í•„ë¦„ê³µì‚¬'] != null) {
      var lv = laborResult['ë„ë°°í•„ë¦„ê³µì‚¬'];
      var mv = materialResult['ë„ë°°í•„ë¦„ê³µì‚¬'];
      laborResult['ë„ë°°ê³µì‚¬'] = (laborResult['ë„ë°°ê³µì‚¬'] || 0) + Math.floor(lv / 2);
      laborResult['í•„ë¦„ê³µì‚¬'] = (laborResult['í•„ë¦„ê³µì‚¬'] || 0) + (lv - Math.floor(lv / 2));
      materialResult['ë„ë°°ê³µì‚¬'] = (materialResult['ë„ë°°ê³µì‚¬'] || 0) + Math.floor(mv / 2);
      materialResult['í•„ë¦„ê³µì‚¬'] = (materialResult['í•„ë¦„ê³µì‚¬'] || 0) + (mv - Math.floor(mv / 2));
      delete laborResult['ë„ë°°í•„ë¦„ê³µì‚¬'];
      delete materialResult['ë„ë°°í•„ë¦„ê³µì‚¬'];
    }
    return JSON.stringify({ labor: laborResult, material: materialResult });
  } catch (e) {
    return JSON.stringify({ labor: {}, material: {} });
  }
}

/** HTML ì´ìŠ¤ì¼€ì´í”„ (ì„œë²„ìš©) */
function escapeHtml_(s) {
  if (s == null || s === '') return '';
  var str = String(s);
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

/**
 * ê²¬ì  ì‹œíŠ¸ë¥¼ ì½ì–´ ê²¬ì  PDFìš© HTML ë¬¸ìì—´ ë°˜í™˜ (ê²¬ì ë‚´ê¸° PDF ë‚´ë³´ë‚´ê¸°ì™€ ë™ì¼ í˜•ì‹)
 */
function getEstimatePdfHtml(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return '';
    var sheetName = 'ê²¬ì _' + sanitizeSheetName_(String(siteName || '').trim());
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return '';
    var lastRow = sheet.getLastRow();
    if (lastRow < 8) return '';
    var data = sheet.getRange(1, 1, lastRow, 10).getValues();
    var siteNameVal = siteName || '';
    var areaVal = '';
    if (data.length > 1) {
      var r1 = data[1];
      if (r1 && r1[1]) siteNameVal = String(r1[1]).trim();
      if (r1 && r1[3]) areaVal = String(r1[3]).replace(/í‰/g, '').trim();
    }
    var headerRowIndex = -1;
    for (var h = 0; h < Math.min(10, data.length); h++) {
      if (String(data[h][0] || '').trim() === 'No') { headerRowIndex = h; break; }
    }
    if (headerRowIndex < 0) return '';
    var categories = [];
    var byCategory = {};
    var currentCat = null;
    var subtotal = 0, overhead = 0, profit = 0, adjusted = 0, total = 0;
    for (var r = headerRowIndex + 1; r < data.length; r++) {
      var row = data[r];
      var b1 = String(row[1] || '').trim();
      var b9 = String(row[8] || '').trim(); // ì†Œê³„/ê³µê³¼ì¡ë¹„/ì´ìœ¤/ì¡°ì •ì•¡/ì´ì•¡ì€ 9ë²ˆì§¸ ì—´ì— ì €ì¥ë¨
      if (b1.indexOf('â– ') === 0) {
        currentCat = b1.replace(/^â– \s*/, '').trim();
        if (currentCat && byCategory[currentCat] === undefined) { categories.push(currentCat); byCategory[currentCat] = []; }
        continue;
      }
      if (b1.indexOf(' ì†Œê³„') !== -1) { currentCat = null; continue; }
      if (currentCat && row[0] !== '' && row[0] != null && !isNaN(Number(row[0]))) byCategory[currentCat].push(row);
      if (b9 === 'ì†Œê³„') subtotal = Number(row[9]) || 0;
      if (b9.indexOf('ê³µê³¼ì¡ë¹„') !== -1) overhead = Number(row[9]) || 0;
      if (b9.indexOf('ì´ìœ¤') !== -1) profit = Number(row[9]) || 0;
      if (b9.indexOf('ì¡°ì •ì•¡') !== -1) adjusted = Number(row[9]) || 0;
      if (b9.indexOf('ì´ì•¡') !== -1) total = Number(row[9]) || 0;
    }
    var materialTotal = 0, laborTotal = 0;
    var coverRows = '';
    var coverRowNo = 0;
    for (var c = 0; c < categories.length; c++) {
      var cat = categories[c];
      var items = byCategory[cat] || [];
      if (items.length === 0) continue;
      var catMat = 0, catLabor = 0, catSum = 0;
      for (var i = 0; i < items.length; i++) {
        catMat += Number(items[i][6]) || 0;
        catLabor += Number(items[i][8]) || 0;
        catSum += Number(items[i][9]) || 0;
      }
      materialTotal += catMat;
      laborTotal += catLabor;
      coverRowNo++;
      coverRows += '<tr><td class="text-center">' + coverRowNo + '</td><td>' + escapeHtml_(cat) + '</td><td class="text-center">ì‹</td><td class="text-end">1</td><td class="text-end">' + Math.round(catMat).toLocaleString() + '</td><td class="text-end">' + Math.round(catLabor).toLocaleString() + '</td><td class="text-end">' + Math.round(catSum).toLocaleString() + '</td><td></td></tr>';
    }
    if (!coverRows) coverRows = '<tr><td class="text-center">1</td><td>-</td><td class="text-center">ì‹</td><td class="text-end">1</td><td class="text-end">0</td><td class="text-end">0</td><td class="text-end">0</td><td></td></tr>';
    var rows = '';
    var no = 0;
    for (var c = 0; c < categories.length; c++) {
      var cat = categories[c];
      var items = byCategory[cat] || [];
      if (items.length === 0) continue;
      rows += '<tr class="section-header"><td colspan="10"><strong>â–  ' + escapeHtml_(cat) + '</strong></td></tr>';
      for (var i = 0; i < items.length; i++) {
        no++;
        var it = items[i];
        var qtyD = (it[4] != null && it[4] !== '') ? it[4] : '';
        if (typeof qtyD === 'number' && String(it[1] || '').indexOf('ë‹¨ì±„ì›€') !== -1) qtyD = Number(qtyD).toFixed(1);
        rows += '<tr><td>' + no + '</td><td>' + escapeHtml_(it[1]) + '</td><td>' + escapeHtml_(it[2]) + '</td><td>' + escapeHtml_(it[3]) + '</td><td class="text-end">' + qtyD + '</td><td class="text-end">' + Number(it[5]).toLocaleString() + '</td><td class="text-end">' + Number(it[6]).toLocaleString() + '</td><td class="text-end">' + Number(it[7]).toLocaleString() + '</td><td class="text-end">' + Number(it[8]).toLocaleString() + '</td><td class="text-end">' + Number(it[9]).toLocaleString() + '</td></tr>';
      }
      var catSum = 0;
      for (var i = 0; i < items.length; i++) catSum += Number(items[i][9]) || 0;
      rows += '<tr class="category-subtotal"><td colspan="9" class="text-end"><strong>' + escapeHtml_(cat) + ' ì†Œê³„</strong></td><td class="text-end"><strong>' + Math.round(catSum).toLocaleString() + 'ì›</strong></td></tr>';
    }
    var now = new Date();
    var writeDate = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    var css = 'body{font-family:Malgun Gothic,sans-serif;margin:0;padding:0;box-sizing:border-box}.sheet{width:273mm;min-height:186mm;padding:12mm;margin:0 auto;box-sizing:border-box}.cover-title{font-size:2em;font-weight:bold;text-align:center;margin:20px 0 25px 0}.cover-project-name{font-size:1.1em;margin-bottom:15px}.cover-table{width:100%;border-collapse:collapse;margin:15px 0;font-size:10pt}.cover-table th,.cover-table td{border:1px solid #333;padding:6px 8px;text-align:center}.cover-table th{background:#eee;font-weight:bold}.cover-total-row{background:#e6f3ff;font-weight:bold;font-size:1.05em}h1{font-size:1.4em;margin:0 0 6px 0}table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10pt}th,td{border:1px solid #333;padding:4px 6px}.text-end{text-align:right}tr.section-header td{background:#e0e0e0;font-weight:bold}tr.category-subtotal td{background:#f5f5f5;font-weight:bold}@media print{.sheet{page-break-after:always}.cover-page{page-break-after:always}}';
    var totalVal = total > 0 ? total : (subtotal + overhead + profit + adjusted);
    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ê²¬ì ì„œ - ' + escapeHtml_(siteNameVal) + '</title><style>' + css + '</style></head><body>' +
      '<div class="sheet cover-page"><div class="cover-title">ê²¬ ì  ì„œ</div><div class="cover-project-name"><span class="cover-project-label">ê³µì‚¬ ëª… :</span> ' + escapeHtml_(siteNameVal) + ' &nbsp; <strong>ê²¬ì ì¼ì‹œ:</strong> ' + writeDate + '</div>' +
      '<table class="cover-table"><thead><tr><th style="width:6%">ìˆœë²ˆ</th><th style="width:24%">í’ˆëª©</th><th style="width:6%">ë‹¨ìœ„</th><th style="width:6%">ìˆ˜ëŸ‰</th><th style="width:18%">ì¬ë£Œë¹„</th><th style="width:18%">ë…¸ë¬´ë¹„</th><th style="width:16%">ê¸ˆì•¡</th><th style="width:6%">ë¹„ê³ </th></tr></thead><tbody>' +
      coverRows +
      '<tr><td colspan="4" class="text-end" style="padding-right:10px">ì†Œê³„</td><td class="text-end">' + Math.round(materialTotal).toLocaleString() + '</td><td class="text-end">' + Math.round(laborTotal).toLocaleString() + '</td><td class="text-end">' + Math.round(subtotal).toLocaleString() + '</td><td></td></tr>' +
      '<tr><td colspan="4" class="text-end" style="padding-right:10px">ê³µê³¼ì¡ë¹„(5%)</td><td></td><td></td><td class="text-end">' + Math.round(overhead).toLocaleString() + '</td><td></td></tr>' +
      '<tr><td colspan="4" class="text-end" style="padding-right:10px">ì´ìœ¤(10%)</td><td></td><td></td><td class="text-end">' + Math.round(profit).toLocaleString() + '</td><td></td></tr>' +
      '<tr><td colspan="4" class="text-end" style="padding-right:10px">ì¡°ì •ì•¡</td><td></td><td></td><td class="text-end">' + Math.round(adjusted).toLocaleString() + '</td><td></td></tr>' +
      '<tr class="cover-total-row"><td colspan="4" class="text-end" style="padding-right:10px"><strong>ì´ì•¡ (VAT ë³„ë„)</strong></td><td></td><td></td><td class="text-end"><strong>' + Math.round(totalVal).toLocaleString() + 'ì›</strong></td><td></td></tr></tbody></table></div>' +
      '<div class="sheet"><h1>ê²¬ì ì„œ ìƒì„¸ ë‚´ì—­</h1><div class="info"><strong>í˜„ì¥ëª…:</strong> ' + escapeHtml_(siteNameVal) + ' &nbsp;|&nbsp; <strong>í‰ìˆ˜:</strong> ' + escapeHtml_(areaVal) + 'í‰</div>' +
      '<table><thead><tr><th>No</th><th>í’ˆëª©</th><th>ê·œê²©</th><th>ë‹¨ìœ„</th><th>ìˆ˜ëŸ‰</th><th class="text-end">ì¬ë£Œë¹„ë‹¨ê°€</th><th class="text-end">ì¬ë£Œë¹„ê¸ˆì•¡</th><th class="text-end">ë…¸ë¬´ë¹„ë‹¨ê°€</th><th class="text-end">ë…¸ë¬´ë¹„ê¸ˆì•¡</th><th class="text-end">ê¸ˆì•¡</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
    return html;
  } catch (e) {
    return '';
  }
}

/**
 * ê²¬ì ì„œ PDF Blob ìƒì„± (ë‚´ë¶€ ê³µí†µ)
 * @param {string} siteName - í˜„ì¥ëª…
 * @returns {{ blob: Blob, name: string }} ë˜ëŠ” null
 */
function generateEstimatePdf_(siteName) {
  try {
    var ss = getSpreadsheet_();
    if (!ss) return null;
    var sheetName = 'ê²¬ì _' + sanitizeSheetName_(String(siteName || '').trim());
    var sheet = ss.getSheetByName(sheetName);
    if (!sheet) return null;
    var lastRow = sheet.getLastRow();
    if (lastRow < 8) return null;
    var data = sheet.getRange(1, 1, lastRow, 10).getValues();
    var siteNameVal = siteName || '';
    var areaVal = '';
    if (data.length > 1) {
      var r1 = data[1];
      if (r1 && r1[1]) siteNameVal = String(r1[1]).trim();
      if (r1 && r1[3]) areaVal = String(r1[3]).replace(/í‰/g, '').trim();
    }
    var headerRowIndex = -1;
    for (var h = 0; h < Math.min(10, data.length); h++) {
      if (String(data[h][0] || '').trim() === 'No') { headerRowIndex = h; break; }
    }
    if (headerRowIndex < 0) return null;
    var categories = [], byCategory = {}, currentCat = null;
    var subtotal = 0, overhead = 0, profit = 0, adjusted = 0, total = 0;
    for (var r = headerRowIndex + 1; r < data.length; r++) {
      var row = data[r];
      var b1 = String(row[1] || '').trim();
      var b9 = String(row[8] || '').trim();
      if (b1.indexOf('â– ') === 0) {
        currentCat = b1.replace(/^â– \s*/, '').trim();
        if (currentCat && byCategory[currentCat] === undefined) { categories.push(currentCat); byCategory[currentCat] = []; }
        continue;
      }
      if (b1.indexOf(' ì†Œê³„') !== -1) { currentCat = null; continue; }
      if (currentCat && row[0] !== '' && row[0] != null && !isNaN(Number(row[0]))) byCategory[currentCat].push(row);
      if (b9 === 'ì†Œê³„') subtotal = Number(row[9]) || 0;
      if (b9.indexOf('ê³µê³¼ì¡ë¹„') !== -1) overhead = Number(row[9]) || 0;
      if (b9.indexOf('ì´ìœ¤') !== -1) profit = Number(row[9]) || 0;
      if (b9.indexOf('ì¡°ì •ì•¡') !== -1) adjusted = Number(row[9]) || 0;
      if (b9.indexOf('ì´ì•¡') !== -1) total = Number(row[9]) || 0;
    }
    var materialTotal = 0, laborTotal = 0;
    var coverRows = [['ìˆœë²ˆ', 'í’ˆëª©', 'ë‹¨ìœ„', 'ìˆ˜ëŸ‰', 'ì¬ë£Œë¹„', 'ë…¸ë¬´ë¹„', 'ê¸ˆì•¡', 'ë¹„ê³ ']];
    var coverRowNo = 0;
    for (var c = 0; c < categories.length; c++) {
      var cat = categories[c];
      var items = byCategory[cat] || [];
      if (items.length === 0) continue;
      var catMat = 0, catLabor = 0, catSum = 0;
      for (var i = 0; i < items.length; i++) {
        catMat += Number(items[i][6]) || 0;
        catLabor += Number(items[i][8]) || 0;
        catSum += Number(items[i][9]) || 0;
      }
      materialTotal += catMat;
      laborTotal += catLabor;
      coverRowNo++;
      coverRows.push([String(coverRowNo), cat, 'ì‹', '1', Math.round(catMat).toLocaleString(), Math.round(catLabor).toLocaleString(), Math.round(catSum).toLocaleString(), '']);
    }
    if (coverRows.length <= 1) coverRows.push(['1', '-', 'ì‹', '1', '0', '0', '0', '']);
    coverRows.push(['', '', '', 'ì†Œê³„', Math.round(materialTotal).toLocaleString(), Math.round(laborTotal).toLocaleString(), Math.round(subtotal).toLocaleString(), '']);
    coverRows.push(['', '', '', 'ê³µê³¼ì¡ë¹„(5%)', '', '', Math.round(overhead).toLocaleString(), '']);
    coverRows.push(['', '', '', 'ì´ìœ¤(10%)', '', '', Math.round(profit).toLocaleString(), '']);
    coverRows.push(['', '', '', 'ì¡°ì •ì•¡', '', '', Math.round(adjusted).toLocaleString(), '']);
    var totalVal = total > 0 ? total : (subtotal + overhead + profit + adjusted);
    coverRows.push(['', '', '', 'ì´ì•¡ (VAT ë³„ë„)', '', '', Math.round(totalVal).toLocaleString() + 'ì›', '']);
    var now = new Date();
    var writeDate = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    var doc = DocumentApp.create('ê²¬ì ì„œ - ' + siteNameVal);
    var body = doc.getBody();
    body.clear();
    body.appendParagraph('ê²¬ ì  ì„œ').setAlignment(DocumentApp.HorizontalAlignment.CENTER).setHeading(DocumentApp.ParagraphHeading.HEADING1);
    body.appendParagraph('ê³µì‚¬ ëª… : ' + siteNameVal + '    ê²¬ì ì¼ì‹œ: ' + writeDate);
    body.appendTable(coverRows);
    body.appendParagraph('').appendPageBreak();
    body.appendParagraph('ê²¬ì ì„œ ìƒì„¸ ë‚´ì—­').setHeading(DocumentApp.ParagraphHeading.HEADING2);
    body.appendParagraph('í˜„ì¥ëª…: ' + siteNameVal + '  |  í‰ìˆ˜: ' + areaVal + 'í‰');
    var detailRows = [['No', 'í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ìˆ˜ëŸ‰', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ì¬ë£Œë¹„ê¸ˆì•¡', 'ë…¸ë¬´ë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ê¸ˆì•¡', 'ê¸ˆì•¡']];
    var no = 0;
    for (var c = 0; c < categories.length; c++) {
      var cat = categories[c];
      var items = byCategory[cat] || [];
      if (items.length === 0) continue;
      for (var i = 0; i < items.length; i++) {
        no++;
        var it = items[i];
        var qtyD = (it[4] != null && it[4] !== '') ? it[4] : '';
        if (typeof qtyD === 'number' && String(it[1] || '').indexOf('ë‹¨ì±„ì›€') !== -1) qtyD = Number(qtyD).toFixed(1);
        detailRows.push([String(no), String(it[1] || ''), String(it[2] || ''), String(it[3] || ''), String(qtyD), Number(it[5]).toLocaleString(), Number(it[6]).toLocaleString(), Number(it[7]).toLocaleString(), Number(it[8]).toLocaleString(), Number(it[9]).toLocaleString()]);
      }
      var catSum = 0;
      for (var i = 0; i < items.length; i++) catSum += Number(items[i][9]) || 0;
      detailRows.push(['', cat + ' ì†Œê³„', '', '', '', '', '', '', '', Math.round(catSum).toLocaleString() + 'ì›']);
    }
    body.appendTable(detailRows);
    doc.saveAndClose();
    var pdfBlob = DriveApp.getFileById(doc.getId()).getAs('application/pdf');
    var name = 'ê²¬ì ì„œ - ' + siteNameVal + '.pdf';
    pdfBlob.setName(name);
    DriveApp.getFileById(doc.getId()).setTrashed(true);
    return { blob: pdfBlob, name: name };
  } catch (e) {
    return null;
  }
}

/** ìˆ«ì í¬ë§· (GAS í˜¸í™˜) */
function numFmt_(n) {
  var x = Number(n);
  if (isNaN(x)) return '0';
  return (typeof x.toLocaleString === 'function') ? x.toLocaleString() : String(x);
}
function pad2_(n) {
  n = Number(n);
  return (n < 10 && n >= 0) ? '0' + n : String(n);
}

/**
 * ê²¬ì  ë°ì´í„°(JSON)ë¡œ PDF Blob ìƒì„± â€” ì‹œíŠ¸ ì €ì¥ ì—†ì´ í˜„ì¬ í™”ë©´ ê¸°ì¤€
 * @param {Object} data - { siteName, area, items: [{ category, item, spec, unit, qty, materialPrice, materialAmount, laborPrice, laborAmount, totalAmount }], subtotal, overhead, profit, adjusted, total }
 * @returns {{ blob: Blob, name: string }} ë˜ëŠ” null
 */
function generateEstimatePdfFromData_(data) {
  if (!data || !data.items || !data.items.length) return null;
  var siteNameVal = String(data.siteName || '').trim() || 'í˜„ì¥ëª… ë¯¸ì§€ì •';
  var areaVal = String(data.area != null ? data.area : '').replace(/í‰/g, '').trim();
  var categoryOrder = ['ê°€ì„¤ì² ê±°', 'ëª©ê³µì‚¬', 'ì „ê¸°ê³µì‚¬', 'ì„¤ë¹„ê³µì‚¬', 'í™”ì¥ì‹¤ê³µì‚¬', 'ë„ë°°ê³µì‚¬', 'í•„ë¦„ê³µì‚¬', 'ë°”ë‹¥ê³µì‚¬', 'ì‹±í¬ê°€êµ¬ê³µì‚¬', 'ë„ì¥ê³µì‚¬', 'ê¸ˆì†ìœ ë¦¬ê³µì‚¬', 'ê¸°íƒ€ê³µì‚¬'];
  var byCategory = {};
  for (var ii = 0; ii < data.items.length; ii++) {
    var it = data.items[ii];
    var cat = String(it && it.category !== undefined ? it.category : '').trim() || 'ê¸°íƒ€ê³µì‚¬';
    if (!byCategory[cat]) byCategory[cat] = [];
    byCategory[cat].push(it);
  }
  var subtotal = Number(data.subtotal) || 0;
  var overhead = Number(data.overhead) || 0;
  var profit = Number(data.profit) || 0;
  var adjusted = Number(data.adjusted) || 0;
  var total = Number(data.total) || (subtotal + overhead + profit);
  var materialTotal = 0, laborTotal = 0;
  var coverRows = [['ìˆœë²ˆ', 'í’ˆëª©', 'ë‹¨ìœ„', 'ìˆ˜ëŸ‰', 'ì¬ë£Œë¹„', 'ë…¸ë¬´ë¹„', 'ê¸ˆì•¡', 'ë¹„ê³ ']];
  var coverRowNo = 0;
  for (var c = 0; c < categoryOrder.length; c++) {
    var cat = categoryOrder[c];
    var items = byCategory[cat];
    if (!items || items.length === 0) continue;
    var catMat = 0, catLabor = 0, catSum = 0;
    for (var i = 0; i < items.length; i++) {
      catMat += Number(items[i].materialAmount) || 0;
      catLabor += Number(items[i].laborAmount) || 0;
      catSum += Number(items[i].totalAmount) || 0;
    }
    materialTotal += catMat;
    laborTotal += catLabor;
    coverRowNo++;
    coverRows.push([String(coverRowNo), cat, 'ì‹', '1', numFmt_(Math.round(catMat)), numFmt_(Math.round(catLabor)), numFmt_(Math.round(catSum)), '']);
  }
  if (coverRows.length <= 1) coverRows.push(['1', '-', 'ì‹', '1', '0', '0', '0', '']);
  coverRows.push(['', '', '', 'ì†Œê³„', numFmt_(Math.round(materialTotal)), numFmt_(Math.round(laborTotal)), numFmt_(Math.round(subtotal)), '']);
  coverRows.push(['', '', '', 'ê³µê³¼ì¡ë¹„(5%)', '', '', numFmt_(Math.round(overhead)), '']);
  coverRows.push(['', '', '', 'ì´ìœ¤(10%)', '', '', numFmt_(Math.round(profit)), '']);
  coverRows.push(['', '', '', 'ì¡°ì •ì•¡', '', '', numFmt_(Math.round(adjusted)), '']);
  var totalVal = total > 0 ? total : (subtotal + overhead + profit);
  coverRows.push(['', '', '', 'ì´ì•¡ (VAT ë³„ë„)', '', '', numFmt_(Math.round(totalVal)) + 'ì›', '']);
  var now = new Date();
  var writeDate = now.getFullYear() + '-' + pad2_(now.getMonth() + 1) + '-' + pad2_(now.getDate());
  var doc = DocumentApp.create('ê²¬ì ì„œ - ' + siteNameVal);
  var body = doc.getBody();
  body.clear();
  body.appendParagraph('ê²¬ ì  ì„œ').setAlignment(DocumentApp.HorizontalAlignment.CENTER).setHeading(DocumentApp.ParagraphHeading.HEADING1);
  body.appendParagraph('ê³µì‚¬ ëª… : ' + siteNameVal + '    ê²¬ì ì¼ì‹œ: ' + writeDate);
  body.appendTable(coverRows);
  body.appendParagraph('').appendPageBreak();
  body.appendParagraph('ê²¬ì ì„œ ìƒì„¸ ë‚´ì—­').setHeading(DocumentApp.ParagraphHeading.HEADING2);
  body.appendParagraph('í˜„ì¥ëª…: ' + siteNameVal + '  |  í‰ìˆ˜: ' + areaVal + 'í‰');
  var detailRows = [['No', 'í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ìˆ˜ëŸ‰', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ì¬ë£Œë¹„ê¸ˆì•¡', 'ë…¸ë¬´ë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ê¸ˆì•¡', 'ê¸ˆì•¡']];
  var no = 0;
  for (var c = 0; c < categoryOrder.length; c++) {
    var cat = categoryOrder[c];
    var items = byCategory[cat];
    if (!items || items.length === 0) continue;
    for (var i = 0; i < items.length; i++) {
      no++;
      var it = items[i];
      var qtyD = (it.qty != null && it.qty !== '') ? it.qty : '';
      if (typeof qtyD === 'number' && String(it.item || '').indexOf('ë‹¨ì±„ì›€') !== -1) qtyD = Number(qtyD).toFixed(1);
      detailRows.push([String(no), String(it.item || ''), String(it.spec || ''), String(it.unit || ''), String(qtyD), numFmt_(it.materialPrice), numFmt_(it.materialAmount), numFmt_(it.laborPrice), numFmt_(it.laborAmount), numFmt_(it.totalAmount)]);
    }
    var catSum = 0;
    for (var i = 0; i < items.length; i++) catSum += Number(items[i].totalAmount) || 0;
    detailRows.push(['', cat + ' ì†Œê³„', '', '', '', '', '', '', '', numFmt_(Math.round(catSum)) + 'ì›']);
  }
  body.appendTable(detailRows);
  doc.saveAndClose();
  var pdfBlob = DriveApp.getFileById(doc.getId()).getAs('application/pdf');
  var name = 'ê²¬ì ì„œ - ' + siteNameVal + '.pdf';
  pdfBlob.setName(name);
  DriveApp.getFileById(doc.getId()).setTrashed(true);
  return { blob: pdfBlob, name: name };
}

/**
 * ê²¬ì ì„œ PDFë¥¼ Google Driveì— ì €ì¥í•˜ê³  ë§í¬ ë°˜í™˜ (íƒœë¸”ë¦¿/ìŠ¤ë§ˆíŠ¸í°ìš©)
 */
function saveEstimatePdfToDrive(siteName) {
  try {
    var gen = generateEstimatePdf_(siteName);
    if (!gen || !gen.blob) return null;
    var pdfFile = DriveApp.getRootFolder().createFile(gen.blob);
    return { url: pdfFile.getUrl(), id: pdfFile.getId(), name: pdfFile.getName() };
  } catch (e) {
    return null;
  }
}

/**
 * ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
 * - password: ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸
 * - ë°˜í™˜: true/false
 */
function verifyAdminPassword(password) {
  // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸: "2021"
  const correctPassword = '2021';
  return String(password || '').trim() === correctPassword;
}

/**
 * ğŸ’¾ í’ˆëª© ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ì €ì¥
 * - category: ê³µì •ëª… (ì˜ˆ: "ëª©ê³µì‚¬")
 * - items: í’ˆëª© ë°°ì—´ [{item, spec, unit, materialPrice, laborPrice}, ...]
 * - í•œ ë²ˆì— setValuesë¡œ ì“°ê¸° ë•Œë¬¸ì— appendRow ë°˜ë³µë³´ë‹¤ í›¨ì”¬ ë¹ ë¦„
 */
function savePriceTableItems(category, itemsJson) {
  const lock = LockService.getScriptLock();
  lock.waitLock(10000);
  
  try {
    const ss = getSpreadsheet_();
    const sheetName = category + '(í’ˆëª©)';
    let sheet = ss.getSheetByName(sheetName);
    
    // í’ˆëª© ë°ì´í„° íŒŒì‹±
    const items = JSON.parse(itemsJson);
    
    // í—¤ë” + ì „ì²´ ë°ì´í„°ë¥¼ 2ì°¨ì› ë°°ì—´ë¡œ êµ¬ì„± (í•œ ë²ˆì— ì“°ê¸°)
    const rows = [['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€']];
    items.forEach(function(item) {
      rows.push([
        String(item.item || ''),
        String(item.spec || ''),
        String(item.unit || ''),
        Number(item.materialPrice || 0),
        Number(item.laborPrice || 0)
      ]);
    });
    
    // ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!sheet) {
      sheet = ss.insertSheet(sheetName);
      for (let col = 1; col <= 5; col++) {
        sheet.setColumnWidth(col, 150);
      }
    }
    
    // í•œ ë²ˆì— ì“°ê¸° (appendRow ë°˜ë³µ ëŒ€ì‹  setValues 1íšŒ)
    if (rows.length > 0) {
      sheet.getRange(1, 1, rows.length, 5).setValues(rows);
      // ê¸°ì¡´ì— ë” ë§ì€ í–‰ì´ ìˆì—ˆìœ¼ë©´ ë‚¨ì€ í–‰ ì‚­ì œ
      const lastRow = sheet.getLastRow();
      if (lastRow > rows.length) {
        sheet.deleteRows(rows.length + 1, lastRow - rows.length);
      }
    }
    
    // í—¤ë” ì„œì‹ (1í–‰ë§Œ)
    const headerRange = sheet.getRange(1, 1, 1, 5);
    headerRange.setBackground('#000000');
    headerRange.setFontColor('#FFFFFF');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');

    CacheService.getScriptCache().remove(PRICE_TABLES_CACHE_KEY);
    return 'âœ… ' + category + ' í’ˆëª© ' + items.length + 'ê°œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
  } catch (e) {
    return 'âŒ ì €ì¥ ì˜¤ë¥˜: ' + e.toString();
  } finally {
    lock.releaseLock();
  }
}

/**
 * ğŸ¯ ë‹¨ê°€í‘œ ì´ˆê¸° ì„¤ì • (ìµœì´ˆ 1íšŒë§Œ ì‹¤í–‰)
 * - Apps Script ì—ë””í„°ì—ì„œ ì´ í•¨ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ì‹¤í–‰ ë²„íŠ¼ í´ë¦­
 * - ëª¨ë“  ë‹¨ê°€í‘œ ì‹œíŠ¸ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤
 */
function setupPriceTables() {
  const ss = getSpreadsheet_();
  
  // ë‹¨ê°€í‘œ ë°ì´í„° ì •ì˜
  const priceTables = {
    'ëª©ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ì–‘ë©´ë²½ì²´ê³µì‚¬', '', 'mÂ²', 17000, 19000],
      ['ë‹¨ë©´ë²½ì²´ê³µì‚¬', '', 'mÂ²', 12000, 13000],
      ['ì²œì¥ê³µì‚¬', '', 'mÂ²', 15000, 16000],
      ['ì²œì¥ê¸°ì´ˆ í‹€ëŒ€ë‹¬ê¸°', '', 'm', 5000, 7500],
      ['ë¬¸í‹€ì‹œê³µ', '100ë°• ë°±ê³¨', 'ê°œ', 120000, 20000],
      ['ë¬¸í‹€ë³´ìˆ˜', '100ë°• ë°±ê³¨', 'ê°œ', 80000, 35000],
      ['ë¬¸ì§ì‹œê³µ', 'ë°±ê³¨(ì†ì¡ì´,ê²½ì²©í¬í•¨)', 'ê°œ', 120000, 30000],
      ['ë¬¸+ë¬¸í‹€ì‹œê³µ', '100ë°• ë°±ê³¨(ì†ì¡ì´,ê²½ì²©í¬í•¨)', 'ê°œ', 270000, 65000],
      ['ë¬¸í‹€ëª¨ì–‘ë‚´ê¸°', '', 'ê°œ', 0, 0],
      ['ì¤‘ë¬¸ ìŠ¬íŒ€ ë„ì–´', 'ë†’ì´2100', 'ê°œ', 1200000, 200000],
      ['ì¤‘ë¬¸ìŠ¬íŒ€3ì—°ë™', 'ë†’ì´2100', 'ê°œ', 800000, 200000],
      ['ìƒë¶€ì¥ì œì‘', '', 'm', 65000, 50000],
      ['í•˜ë¶€ì¥ì œì‘', '', 'm', 75000, 50000],
      ['ëª°ë”©ì‹œê³µ', '20cmê³„ë‹¨ëª°ë”© ë°±ìƒ‰', 'm', 2500, 4500],
      ['ê±¸ë ˆë°›ì´ì‹œê³µ', '30cm ë°±ìƒ‰', 'm', 2500, 3500],
      ['ìš°ë¬¼ì²œì¥ë§Œë“¤ê¸°', '', 'mÂ²', 12000, 15000],
      ['ë‹¨ì—´ì‘ì—…', '', 'mÂ²', 15000, 13500],
      ['ë³´ê°•ì‘ì—…', '', 'ì‹', 0, 0],
      ['ë²½ì²´ ëª¨ì–‘ë‚´ê¸°', '', 'ì‹', 0, 0],
      ['ë‹¤í…Œì¼ê³µì‚¬', '', 'ì‹', 0, 0],
      ['ê³µêµ¬ì†ë£Œ', '', 'ì¸', 0, 60000],
      ['ì² ë¬¼', '', 'ì‹', 0, 0]
    ],
    
    'ì „ê¸°ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ì „ê¸°ë°°ì„ ê³µì‚¬(ì¸)', 'ì „ì„  ë° ë°°ê´€', 'ì¸', 25000, 280000],
      ['ì „ê¸°ë°°ì„ ê³µì‚¬(í‰)', 'ì „ì„  ë° ë°°ê´€', 'í‰', 40000, 120000],
      ['ë¶„ì „í•œ êµì²´ê³µì‚¬', '', 'ì‹', 0, 0],
      ['ë‹¨ë… ì „ê¸°ì„  ê³µì‚¬', '', 'í‰', 0, 0],
      ['ë§¤ì… ì„¼ì„œë“±', '3ì¸ì¹˜ íƒ€ê³µí˜•', 'ê°œ', 27000, 4000],
      ['ì„¼ì„œë“±', '6ì¸ì¹˜', 'ê°œ', 15000, 4000],
      ['ê±°ì‹¤ë“±', '', 'ê°œ', 160000, 6000],
      ['ë°©ë“±', 'ì˜¤ìŠ¤ëŒled', 'ê°œ', 55000, 4000],
      ['ì£¼ë°©ë“±', 'ì½”ì½¤led', 'ê°œ', 35000, 4000],
      ['ì‹íƒë“±', 'ledí¬í•¨', 'ê°œ', 45000, 4000],
      ['ë² ë€ë‹¤ë“±', '', 'ê°œ', 25000, 4000],
      ['ê±°ì‹¤ë²½ë“±', '', 'ê°œ', 18000, 4000],
      ['3ì¸ì¹˜ ë§¤ì…ë“±', '', 'ê°œ', 4500, 2500],
      ['ë§¤ì…í˜• ìŠ¤í”¼ì»¤', '', 'ê°œ', 18000, 6000],
      ['ê´‘ì •ì‹ ê°ì§€ê¸°', '', 'ê°œ', 45000, 2000],
      ['ì•Œì‚°í™”íƒ„ì†Œê°ì§€ê¸°', '', 'ê°œ', 68000, 2000],
      ['ì°¨ë™ì‹ê°ì§€ê¸°', '', 'ê°œ', 8000, 2000],
      ['ìŠ¤ìœ„ì¹˜', 'ì œì¼ë””ì•„íŠ¸ 1ê¸‰ ê¸°ì¤€', 'ê°œ', 2600, 2000],
      ['ì½˜ì„¼íŠ¸', 'ì œì¼ë””ì•„íŠ¸ 2ê¸‰ ê¸°ì¤€', 'ê°œ', 3000, 2000],
      ['ë°©ìš°ì½˜ì„¼íŠ¸', 'ì œì¼ë””ì•„íŠ¸ 2ê¸‰ ê¸°ì¤€', 'ê°œ', 5000, 2000],
      ['ì „í™”,ì¸í„°ë„· ì½˜ì„¼íŠ¸', '', 'ê°œ', 3000, 2000],
      ['T5', '1200mmê¸°ì¤€', 'ê°œ', 10000, 1000],
      ['T5ê°„ì ‘ë¼ì¸', '1200mmê¸°ì¤€', 'ê°œ', 10000, 1000],
      ['ë ˆì¸ìŠ¤ì›¨ì´', '', 'm', 16000, 10000],
      ['ë ˆì¼', '', 'm', 10000, 4000],
      ['ë ˆì¼ë“±', 'ë¹„ì¸ ë¡œ ì›í†µ v cob 10w', 'ê°œ', 8000, 1000],
      ['ë²½ê¹Œê¸°', '', 'm', 0, 25000],
      ['ì‹¤ë§íŒ¬', 'ë¡œìŠ¬ëŸ¬ í”„ë¼ì„R 17cm', 'ê°œ', 309000, 30000]
    ],
    
    'í™”ì¥ì‹¤ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['í™”ì¥ì‹¤ ë°”ë‹¥íƒ€ì¼', '600*600', 'mÂ²', 22000, 24000],
      ['í™”ì¥ì‹¤ ë²½ì²´íƒ€ì¼', '600*600', 'mÂ²', 22000, 24000],
      ['ë§¤ì§€', '', 'ì¸', 0, 250000],
      ['ë§¤ì§€ ë¶€ìì¬', '', 'í¬', 0, 0],
      ['íƒ€ì¼ë¶€ìì¬', '', 'mÂ²', 10000, 0],
      ['ì–‘ë³€ê¸°', 'into ì–‘ë³€ê¸° c1002', 'ê°œ', 190000, 40000],
      ['ì„¸ë©´ëŒ€', 'into ì„¸ë©´ëŒ€ L337-1', 'ê°œ', 140000, 50000],
      ['ì„¸ë©´ìˆ˜ì „', 'ë¹„ì—”íŠ¸ GB 5001 SS', 'ê°œ', 42500, 8500],
      ['ìš•ì¡°ìƒ¤ì›Œìˆ˜ì „', 'ë¹„ì—”íŠ¸ GB 5005 SS', 'ê°œ', 85000, 10000],
      ['ìš•ì‹¤ì•¡ì„œì‚¬ë¦¬', 'ë¹„ì—”íŠ¸ 4í’ˆì„¸íŠ¸', 'ê°œ', 75000, 10000],
      ['ìˆ˜ê±´ê±¸ì´', 'ë¹„ì—”íŠ¸', 'ê°œ', 25000, 3000],
      ['íœ´ì§€ê±¸ì´', 'ë¹„ì—”íŠ¸', 'ê°œ', 28000, 3000],
      ['íŠ¸ë Œì¹˜ ë¼ì¸ ìœ ê°€(í†µ)', 'ë¹„ì—”íŠ¸ 66*800', 'ê°œ', 93000, 15000],
      ['ë¼ì¸ ìœ ê°€(ì‚¬ê°)', 'ë¹„ì—”íŠ¸ 150*150', 'ê°œ', 35000, 10000],
      ['ì²­ì†Œê±¸', 'ë¹„ì—”íŠ¸ ì²­ì†Œê±¸', 'ê°œ', 18000, 5000],
      ['í•´ë°”ë¼ê¸°ìƒ¤ì›Œìˆ˜ì „', 'ë¹„ì—”íŠ¸ ë ˆì¸ìˆ˜ì „2009', 'ê°œ', 140000, 15000],
      ['ìŠµì§„ì¥', '', 'ê°œ', 160000, 20000],
      ['ë”ì²œì¥', '1500*800', 'ê°œ', 160000, 30000],
      ['ê°„ì ‘ íƒ€ì… ìš•ì‹¤ê±°ìš¸', '600*800', 'ê°œ', 130000, 10000],
      ['ìš•ì¡°', 'ë§¤ë¦½ìš•ì¡°1500~1700mm', 'ê°œ', 185000, 40000],
      ['ìš•ì¡°ì¡°ì ', '', 'ì‹', 80000, 120000],
      ['ì  ë‹¤ì´ë§Œë“¤ê¸°', '', 'ì‹', 90000, 120000],
      ['ìŠ¬ë¦¬ì»·ì‹œê³µ', '', 'm', 0, 20000],
      ['íƒ€ì¼ì„¸ë©´ëŒ€', '700*465*250', 'ê°œ', 450000, 150000],
      ['íœ´ì  íŠ¸', 'FHD-P150S1', 'ê°œ', 396000, 20000],
      ['í˜í ì²œí’ê¸°', 'C2-100LF', 'ê°œ', 49000, 15000],
      ['í•˜ì¸  í‹°ì˜¤ëŒ ë¯¸ë‹ˆ í™˜í’ê¸°', 'í‹°ì˜¤ëŒ ë¯¸ë‹ˆ', 'ê°œ', 0, 0],
      ['ê°€ë²½', 'í¼ì„¸ë¼ë¯¹', 'ì¥', 25000, 60000],
      ['íë¹„í´', '', 'mÂ²', 85000, 13000],
      ['ìœ ë¦¬ë¶€ìŠ¤', '', 'mÂ²', 85000, 13000],
      ['ì¡ë¶€', 'ì•—ì£µ', 'ì¸', 0, 160000]
    ],
    
    'ê°€ì„¤ì² ê±°(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ë¨¹ë©”ê¹€/ë‚´ë¶€ ìˆ˜í‰ë¹„ê³„', '', 'mÂ²', 700, 0],
      ['ë³´ì–‘/í˜„ì¥ ì •ë¦¬ì‘ì—…', '', 'mÂ²', 650, 1300],
      ['ê³µì‚¬ì¤‘íìì¬ë°˜ì¶œ', '1ton íŠ¸ëŸ­', 'ëŒ€', 280000, 150000],
      ['ì „ì²´ì² ê±°', '', 'í‰', 0, 35000],
      ['ì²œì¥ì² ê±°', '', 'mÂ²', 0, 10000],
      ['ë²½ë©´ì² ê±°', '', 'mÂ²', 0, 8334],
      ['ì¡°ëª…ì² ê±°', '', 'í‰', 0, 5000],
      ['í™”ì¥ì‹¤ ì§‘ê¸°ì² ê±°', 'íƒì›”ì œì™¸', 'ê°œì†Œ', 0, 80000],
      ['í™”ì¥ì‹¤ íƒ€ì¼ì œê±°', 'ë°©ìˆ˜ì „ê¹Œì§€', 'mÂ²', 0, 15000],
      ['í™”ë‹¨ì² ê±°', '', 'ê°œì†Œ', 0, 50000],
      ['ë§ˆë£¨ì² ê±°', '', 'í‰', 0, 30000],
      ['íƒ€ì¼ì² ê±°', '', 'mÂ²', 0, 15000],
      ['í™•ì¥ë¶€ì² ê±°', '', 'ê°œ', 0, 300000],
      ['ëŒ€ì½”íƒ€ì¼ì² ê±°', '', 'í‰', 0, 25000],
      ['ì¥íŒì² ê±°', '', 'í‰', 0, 8000],
      ['ë¶™ë°•ì´ì¥ì² ê±°', '30cm', 'ì', 0, 9000],
      ['ì‹ ë°œì¥ì² ê±°', '30cm', 'ì', 0, 9000],
      ['ëª°ë”©, ê±¸ë ˆë°›ì´ì² ê±°', '', 'í‰', 0, 6500],
      ['ì‹±í¬ëŒ€ì² ê±°', '30cm', 'ì', 0, 9000],
      ['ë°©ë¬¸ì² ê±°', '', 'ê°œ', 0, 12000],
      ['ë°©ë¬¸+ë¬¸í‹€ì² ê±°', '', 'ê°œì†Œ', 0, 23000],
      ['ë¬¸ì§€ë°© ì² ê±°', 'ë¯¸ì¥ê¹Œì§€', 'ê°œ', 0, 13000],
      ['ì¤‘ë¬¸ì² ê±°', '', 'ê°œ', 0, 50000],
      ['ë² ë€ë‹¤ë¬¸ ì² ê±°', '', 'ê°œ', 0, 35000],
      ['ìƒ¤ì‹œì² ê±°', '', 'ì‹', 0, 0],
      ['ì¡ë¶€', 'ì•—ì¢…', 'ì¸', 0, 180000]
    ],
    
    'ì„¤ë¹„ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ì˜¨ì§ì‹œê³µ', 'ë„¥ìŠ¨íƒ€ì„ì´ ê²½í¬í•¨', 'ê°œ', 120000, 30000],
      ['ëª¬í‹€ë³´ìˆ˜', '100ë°• ë°±ê³¨', 'ê°œ', 80000, 35000],
      ['ì¤‘ë¬¸ìŠ¬ë¦¼ì—°ë™', '', 'ê°œ', 800000, 0],
      ['ëª°ë”©ì‹œê³µ', '20cmê³„ë‹¨ë¡¤íŒ… ë°±ìƒ‰', 'm', 2500, 4500],
      ['ê±¸ë ˆë°›ì´ì‹œê³µ', '30cm ë°±ìƒ‰', 'm', 2500, 3500]
    ],
    
    'ë„ë°°ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ë„ë°°', '', 'í‰', 7000, 8000],
      ['ì‹¤í¬', '', 'í‰', 11000, 9000],
      ['ì¹œí™˜ê²½ë„ë°°', '', 'í‰', 9000, 8000]
    ],
    'í•„ë¦„ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['í•„ë¦„', '', 'M', 12000, 10000]
    ],
    
    'ë°”ë‹¥ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['í˜„ê´€íƒ€ì¼', '600*600', 'mÂ²', 22000, 24000],
      ['ë² ë€ë‹¤íƒ€ì¼', '600*600', 'mÂ²', 22000, 24000],
      ['í™ˆíƒ€ì¼', '600*600', 'mÂ²', 22000, 24000],
      ['íƒ€ì¼ë¶€ìì¬', '', 'mÂ²', 5000, 0],
      ['ê°•ë§ˆë£¨', 'ë™í™” ë‚˜íˆ¬ìŠ¤ì „', 'í‰', 98000, 18000],
      ['ì¥íŒ', 'LG1.8T', 'í‰', 24000, 11000],
      ['ë°ì½”íƒ€ì¼', '', 'í‰', 28000, 11000],
      ['ì• í­ì‹œ', '', 'í‰', 90000, 30000]
    ],
    
    'ì‹±í¬ê°€êµ¬ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ë¶™ë°•ì´ì¥', 'ì(30cm)', '', 110000, 0],
      ['ì‹œìŠ¤í…œì¥', 'ì(30cm)', '', 90000, 0],
      ['ì•„ì¼ëœë“œ', 'ì(30cm)', '', 160000, 0],
      ['ì‹±í¬ëŒ€', 'ê¸°ë³¸í›„ë“œí¬í•¨', 'ì(30cm)', 180000, 0],
      ['ìƒŒë”©ì¥', 'ì(30cm)', '', 160000, 0],
      ['í™”ì¥ëŒ€', 'ì(30cm)', '', 115000, 0],
      ['ì‹±í¬ë¬¸', 'ìƒë¶€ or í•˜ë¶€', 'ì(31cm)', 30000, 0],
      ['ë°±ì¡°ì‹±í¬ë³¼', 'CNR730(400*680*245)', 'ê°œ', 182000, 30000],
      ['ì‹±í¬ìˆ˜ì „', 'ë¹„ì—”íŠ¸ GWS3000', 'ê°œ', 63000, 10000],
      ['ì¸ë•ì…˜', 'ì¿ ì²¸ CIR-EB330TOB2', 'ê°œ', 380000, 30000],
      ['ê°€ìŠ¤ë ˆì¸ì§€', 'í•˜ì¸  GC-3605SDBH', 'ê°œ', 198000, 10000],
      ['ë¶™ë°•ì´ì˜ìì¿ ì…˜', 'ë™ë´‰ì´í¬í•¨', 'ì„(50cm)', 140000, 0],
      ['ëŸ¬ì»¤', '300*600*2100', 'ê°œ', 160000, 0],
      ['ì•Œë°˜ì¥', 'ì(30cm)', '', 110000, 0]
    ],
    
    'ë„ì¥ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ë„ì¥ë°‘ì‘ì—…', 'í¼í‹°ì‘ì—…', 'mÂ²', 3500, 5500],
      ['ë„ì¥ì‘ì—…', '', 'mÂ²', 6000, 4500],
      ['ìŠ¤í…Œì¸ì‘ì—…', '', 'mÂ²', 6500, 5500],
      ['ë¹„ë‹ë³´ì–‘', '', 'mÂ²', 500, 1000],
      ['íƒ„ì„±ì½”íŠ¸', '', 'mÂ²', 13000, 8000]
    ],
    
    'ê¸ˆì†ìœ ë¦¬ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['í˜„ì§€', '', 'ê°œ', 180000, 0],
      ['ìœ ë¦¬', '10T', 'ì', 6800, 0],
      ['ì•…ê±´', '', 'ì¸', 0, 300000],
      ['ê±°ìš¸', '', 'ì', 4500, 0],
      ['ìœ ë¦¬ë¬¸', '900*2100', 'ê°œ', 450000, 0],
      ['ê¸ˆì†íŒŒì´í”„', '30*30ê°', 'm', 0, 0],
      ['ìƒ¤ì‹œê³µì‚¬', 'ì˜ë¦¼ìƒ¤ì‹œ', 'ì‹', 0, 0],
      ['í¬ë ˆì¸', 'í›„íˆ¬ ê±¸ëŒ€', 'ëŒ€', 0, 500000]
    ],
    
    'ê¸°íƒ€ê³µì‚¬(í’ˆëª©)': [
      ['í’ˆëª©', 'ê·œê²©', 'ë‹¨ìœ„', 'ì¬ë£Œë¹„ë‹¨ê°€', 'ë…¸ë¬´ë¹„ë‹¨ê°€'],
      ['ì²­ì†Œ', '', 'í‰', 18000, 0],
      ['ì‹¤ë¦¬ì½˜ë§ˆê°', '', 'í‰', 3000, 15000],
      ['ìŠ¹ê°•ê¸°ì‚¬ìš©ë£Œ', '', 'ì‹', 0, 0],
      ['í¬ë ˆì¸ì‚¬ìš©ë£Œ', 'ë°˜ë‚˜ì ˆ', '', 300000, 0]
    ]
  };
  
  // ê° ë‹¨ê°€í‘œ ì‹œíŠ¸ ìƒì„±
  for (const [sheetName, data] of Object.entries(priceTables)) {
    let sheet = ss.getSheetByName(sheetName);
    
    // ê¸°ì¡´ ì‹œíŠ¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
    if (sheet) {
      ss.deleteSheet(sheet);
    }
    
    // ìƒˆ ì‹œíŠ¸ ìƒì„±
    sheet = ss.insertSheet(sheetName);
    
    // ë°ì´í„° ì…ë ¥
    data.forEach(row => {
      sheet.appendRow(row);
    });
    
    // í—¤ë” í–‰ ì„œì‹ ì„¤ì •
    const headerRange = sheet.getRange(1, 1, 1, 5);
    headerRange.setBackground('#000000');
    headerRange.setFontColor('#FFFFFF');
    headerRange.setFontWeight('bold');
    headerRange.setHorizontalAlignment('center');
    
    // ì—´ ë„ˆë¹„ ì „ì²´ 150px
    for (let col = 1; col <= sheet.getMaxColumns(); col++) {
      sheet.setColumnWidth(col, 150);
    }
    
    Logger.log(`âœ… ${sheetName} ìƒì„± ì™„ë£Œ`);
  }
  
  // ì™„ë£Œ ë©”ì‹œì§€
  const ui = SpreadsheetApp.getUi();
  ui.alert('âœ… ë‹¨ê°€í‘œ ì´ˆê¸° ì„¤ì • ì™„ë£Œ!', 
    `ì´ ${Object.keys(priceTables).length}ê°œì˜ ë‹¨ê°€í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
    'ìƒì„±ëœ ì‹œíŠ¸:\n' +
    Object.keys(priceTables).join('\n'),
    ui.ButtonSet.OK);
}
/**
 * ERPìš© ë„ë©´ ë³´ê´€í•¨ ëª©ë¡ (ì €ì¥ì‹œê°, í˜„ì¥ëª…, ìš”ì•½, ì „ì²´ ë°ì´í„° JSON)
 * - ë°˜í™˜: JSON ë¬¸ìì—´. ë°°ì—´ [ { siteName, savedAt, summary, data }, ... ]
 */
function getDrawingListForErp_() {
  try {
    var ss = getSpreadsheet_();
    var sheet = getDrawingSheet_(ss);
    if (!sheet || sheet.getLastRow() < 2) return '[]';
    var lastRow = sheet.getLastRow();
    var rows = sheet.getRange(2, 1, lastRow, 5).getValues();
    var list = [];
    for (var r = 0; r < rows.length; r++) {
      var row = rows[r];
      var dVal = row[0];
      var siteName = String(row[1] || '').trim();
      var summary = String(row[3] || '').trim();
      var jsonStr = row[4];
      var savedAt = (dVal instanceof Date)
        ? Utilities.formatDate(dVal, 'Asia/Seoul', 'yyyy-MM-dd HH:mm:ss')
        : String(dVal || '');
      var data = null;
      if (typeof jsonStr == 'string' && jsonStr.trim()) {
        try {
          data = JSON.parse(jsonStr);
        } catch (e) {}
      }
      list.push({
        siteName: siteName,
        savedAt: savedAt,
        summary: summary,
        data: data
      });
    }
    list.sort(function(a, b) { return String(b.savedAt || '').localeCompare(String(a.savedAt || '')); });
    return JSON.stringify(list);
  } catch (e) {
    return '[]';
  }
}